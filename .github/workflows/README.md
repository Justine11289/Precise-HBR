# GitHub Actions CI/CD Workflows

æœ¬ç›®éŒ„åŒ…å« PRECISE-HBR SMART on FHIR æ‡‰ç”¨ç¨‹å¼çš„ CI/CD å·¥ä½œæµç¨‹é…ç½®ã€‚

## ğŸ”„ å·¥ä½œæµç¨‹æ¦‚è¦½

| å·¥ä½œæµç¨‹ | è§¸ç™¼æ¢ä»¶ | èªªæ˜ |
|---------|---------|------|
| **CI** (`ci.yml`) | Push/PR to main, PRECISE-HBR, develop | å®Œæ•´çš„æŒçºŒé›†æˆç®¡ç·š |
| **Test** (`test.yml`) | Push/PR (*.py, tests/*, requirements.txt) | å¿«é€Ÿæ¸¬è©¦å¥—ä»¶ |
| **Security Scan** (`security-scan.yml`) | æ¯æ—¥ 2:00 UTC + Push | å®‰å…¨æ¼æ´æƒæ |
| **Performance** (`performance.yml`) | æ¯é€±æ—¥ 3:00 UTC + æ‰‹å‹• | æ€§èƒ½å’Œè² è¼‰æ¸¬è©¦ |
| **Docker Build** (`docker-build.yml`) | Push to main + æ‰‹å‹• | Docker æ˜ åƒå»ºç½® |
| **CD** (`cd.yml`) | Push to main (tag) | æŒçºŒéƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ |

## ğŸ“‹ CI å·¥ä½œæµç¨‹è©³æƒ…

### ä¸»è¦ CI ç®¡ç·š (`ci.yml`)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   code-quality  â”‚ â† ä»£ç¢¼å“è³ªæª¢æŸ¥ (Black, Flake8, Pylint)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  security-scan  â”‚ â† å®‰å…¨æƒæ (Bandit, pip-audit)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ unit  â”‚ â”‚integrationâ”‚ â† ä¸¦è¡Œæ¸¬è©¦
â”‚ tests â”‚ â”‚   tests   â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚           â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ e2e-tests â”‚ â† ç«¯åˆ°ç«¯æ¸¬è©¦
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚security   â”‚ â† å®‰å…¨æ¸¬è©¦
    â”‚  tests    â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ all-tests â”‚ â† å®Œæ•´æ¸¬è©¦å¥—ä»¶ + è¦†è“‹ç‡å ±å‘Š
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚   build   â”‚ â† æ‡‰ç”¨ç¨‹å¼å»ºç½®
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚  docker   â”‚ â† Docker æ˜ åƒå»ºç½®æ¸¬è©¦
    â”‚   build   â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚  summary  â”‚ â† å»ºç½®æ‘˜è¦å ±å‘Š
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¸¬è©¦é¡åˆ¥

| é¡åˆ¥ | æ¸¬è©¦æ–‡ä»¶æ¨¡å¼ | èªªæ˜ |
|------|-------------|------|
| Unit | `test_config*.py`, `test_unit*.py`, `test_risk*.py` | å–®å…ƒæ¸¬è©¦ |
| Integration | `test_integration*.py`, `test_twcore*.py`, `test_fhir*.py` | æ•´åˆæ¸¬è©¦ |
| Security | `test_security*.py`, `test_auth*.py`, `test_audit*.py` | å®‰å…¨æ¸¬è©¦ |
| E2E | `test_app_e2e.py`, `test_hooks.py` | ç«¯åˆ°ç«¯æ¸¬è©¦ |

## ğŸ§ª æ¸¬è©¦å·¥ä½œæµç¨‹ (`test.yml`)

### å¿«é€Ÿæ¸¬è©¦
- åœ¨æ¯å€‹ PR ä¸Šé‹è¡Œ
- è¶…æ™‚é™åˆ¶ï¼š10 åˆ†é˜
- å¤±æ•—æ™‚ç«‹å³åœæ­¢ (`-x` æ¨™èªŒ)

### çŸ©é™£æ¸¬è©¦
æ”¯æ´å¤šå€‹ Python ç‰ˆæœ¬å’Œä½œæ¥­ç³»çµ±ï¼š

| OS | Python ç‰ˆæœ¬ |
|----|-------------|
| Ubuntu | 3.10, 3.11, 3.12 |
| Windows | 3.11 |
| macOS | 3.11 |

## ğŸ”’ å®‰å…¨æƒæ (`security-scan.yml`)

### æƒæå·¥å…·
- **Bandit**: Python ä»£ç¢¼å®‰å…¨åˆ†æ
- **pip-audit**: ä¾è³´æ¼æ´æª¢æŸ¥
- **Safety**: ä¾è³´å®‰å…¨æª¢æŸ¥
- **CodeQL**: GitHub ä»£ç¢¼åˆ†æ
- **Gitleaks**: ç§˜å¯†æª¢æ¸¬
- **License Check**: æˆæ¬Šåˆè¦æª¢æŸ¥

### åŸ·è¡Œé »ç‡
- æ¯æ—¥ 2:00 UTC è‡ªå‹•åŸ·è¡Œ
- ç•¶ `requirements.txt` æˆ– `*.py` æ–‡ä»¶è®Šæ›´æ™‚

## âš¡ æ€§èƒ½æ¸¬è©¦ (`performance.yml`)

### æ¸¬è©¦é¡å‹
1. **Benchmark æ¸¬è©¦**: ä½¿ç”¨ pytest-benchmark
2. **è² è¼‰æ¸¬è©¦**: ä½¿ç”¨ Locust

### é…ç½®åƒæ•¸
- ä¸¦ç™¼ç”¨æˆ¶æ•¸ï¼š10ï¼ˆå¯é…ç½®ï¼‰
- æ¸¬è©¦æŒçºŒæ™‚é–“ï¼š60 ç§’ï¼ˆå¯é…ç½®ï¼‰
- ç”¨æˆ¶ç”Ÿæˆé€Ÿç‡ï¼š2/ç§’

### æ‰‹å‹•è§¸ç™¼
```bash
gh workflow run performance.yml -f users=50 -f duration=120
```

## ğŸ³ Docker å»ºç½® (`docker-build.yml`)

### å»ºç½®åŠŸèƒ½
- ä½¿ç”¨ Docker Buildx
- å•Ÿç”¨ GitHub Actions å¿«å–
- å»ºç½®å¾Œå¥åº·æª¢æŸ¥

## ğŸ“¦ å¿…è¦çš„ Secrets

åœ¨ GitHub å€‰åº«è¨­å®šä¸­é…ç½®ä»¥ä¸‹ Secretsï¼š

| Secret åç¨± | èªªæ˜ | å¿…è¦æ€§ |
|-------------|------|--------|
| `CODECOV_TOKEN` | Codecov ä¸Šå‚³ä»¤ç‰Œ | å¯é¸ |
| `DOCKER_USERNAME` | Docker Hub ç”¨æˆ¶å | éƒ¨ç½²æ™‚éœ€è¦ |
| `DOCKER_PASSWORD` | Docker Hub å¯†ç¢¼ | éƒ¨ç½²æ™‚éœ€è¦ |
| `GCP_PROJECT_ID` | Google Cloud å°ˆæ¡ˆ ID | GCP éƒ¨ç½²æ™‚éœ€è¦ |
| `GCP_SA_KEY` | GCP æœå‹™å¸³æˆ¶é‡‘é‘° | GCP éƒ¨ç½²æ™‚éœ€è¦ |

## ğŸ“Š Artifacts

æ¯æ¬¡é‹è¡Œç”¢ç”Ÿçš„å·¥ä»¶ï¼š

| å·¥ä»¶åç¨± | å…§å®¹ |
|---------|------|
| `unit-test-coverage` | å–®å…ƒæ¸¬è©¦è¦†è“‹ç‡å ±å‘Š |
| `integration-test-coverage` | æ•´åˆæ¸¬è©¦è¦†è“‹ç‡å ±å‘Š |
| `e2e-test-coverage` | E2E æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š |
| `security-test-coverage` | å®‰å…¨æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š |
| `full-test-report` | å®Œæ•´æ¸¬è©¦å ±å‘Š + HTML è¦†è“‹ç‡ |
| `bandit-security-report` | Bandit å®‰å…¨æƒæå ±å‘Š |
| `pip-audit-report` | ä¾è³´æ¼æ´å ±å‘Š |
| `benchmark-results` | æ€§èƒ½åŸºæº–æ¸¬è©¦çµæœ |
| `load-test-results` | è² è¼‰æ¸¬è©¦çµæœ |
| `smart-fhir-app-build` | æ‡‰ç”¨ç¨‹å¼å»ºç½®åŒ… |

## ğŸš€ æœ¬åœ°é‹è¡Œ

### é‹è¡Œæ‰€æœ‰æ¸¬è©¦
```bash
# Windows
.\run_tests.ps1 -All

# Linux/macOS
./run_tests.sh --all
```

### é‹è¡Œç‰¹å®šé¡åˆ¥
```bash
# å–®å…ƒæ¸¬è©¦
pytest tests/test_config*.py tests/test_unit*.py -v

# å®‰å…¨æ¸¬è©¦
pytest tests/test_security*.py tests/test_auth*.py -v

# E2E æ¸¬è©¦
pytest tests/test_app_e2e.py -v
```

### é‹è¡Œè² è¼‰æ¸¬è©¦
```bash
# å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
python -c "from APP import app; app.run(port=8080)"

# åœ¨å¦ä¸€å€‹çµ‚ç«¯é‹è¡Œ Locust
locust -f tests/locustfile.py --host http://localhost:8080
```

## ğŸ“ æ–°å¢æ¸¬è©¦çš„æœ€ä½³å¯¦è¸

1. **å‘½åè¦ç¯„**ï¼šä½¿ç”¨ `test_<category>_<feature>.py` æ ¼å¼
2. **æ¨™è¨˜æ¸¬è©¦**ï¼šä½¿ç”¨ pytest markers æ¨™è¨˜æ¸¬è©¦é¡åˆ¥
3. **ç’°å¢ƒè®Šæ•¸**ï¼šç¢ºä¿æ¸¬è©¦ä¸ä¾è³´ç”Ÿç”¢ç’°å¢ƒè®Šæ•¸
4. **è¶…æ™‚è¨­å®š**ï¼šç‚ºé•·æ™‚é–“é‹è¡Œçš„æ¸¬è©¦è¨­å®šè¶…æ™‚
5. **æ¸…ç†**ï¼šä½¿ç”¨ fixtures ç¢ºä¿æ¸¬è©¦å¾Œæ¸…ç†è³‡æº

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

1. **æ¸¬è©¦è¶…æ™‚**
   - å¢åŠ  `--timeout` å€¼
   - æª¢æŸ¥æ˜¯å¦æœ‰ç„¡é™å¾ªç’°

2. **ç’°å¢ƒè®Šæ•¸ç¼ºå¤±**
   - ç¢ºä¿åœ¨ `env:` å€å¡Šä¸­è¨­å®šæ‰€æœ‰å¿…è¦è®Šæ•¸

3. **ä¾è³´å®‰è£å¤±æ•—**
   - æª¢æŸ¥ `requirements.txt` ç‰ˆæœ¬ç›¸å®¹æ€§
   - å˜—è©¦æ¸…é™¤ pip å¿«å–

4. **Docker å»ºç½®å¤±æ•—**
   - æª¢æŸ¥ Dockerfile èªæ³•
   - ç¢ºèªåŸºç¤æ˜ åƒå¯ç”¨

### æŸ¥çœ‹æ—¥èªŒ
åœ¨ GitHub Actions é é¢ä¸­ï¼Œé»æ“Šå¤±æ•—çš„å·¥ä½œæµç¨‹æŸ¥çœ‹è©³ç´°æ—¥èªŒã€‚
