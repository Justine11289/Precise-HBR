name: CI - Continuous Integration

on:
  push:
    branches: [ main, PRECISE-HBR, develop ]
  pull_request:
    branches: [ main, PRECISE-HBR ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black pylint
        
    - name: Check code formatting with Black
      run: |
        black --check --diff . || echo "::warning::Code formatting issues found"
      continue-on-error: true
        
    - name: Lint with flake8
      run: |
        # Stop on syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true
        
    - name: Analyze with pylint
      run: |
        pylint --exit-zero --disable=all --enable=F,E,W *.py
      continue-on-error: true

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run Bandit security scan
      run: |
        bandit -r . -f json -o bandit-report.json --exclude .venv,venv,env,__pycache__,.git,tests -ll || true
      continue-on-error: true
        
    - name: Upload Bandit report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json
        
    - name: Run pip-audit for dependency vulnerabilities
      run: |
        pip-audit --desc --output pip-audit-report.txt || true
      continue-on-error: true
        
    - name: Upload pip-audit report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pip-audit-report
        path: pip-audit-report.txt

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-flask pytest-xdist
        
    - name: Create test directories
      run: |
        mkdir -p instance/flask_session
        
    - name: Run unit tests
      run: |
        pytest tests/test_config*.py tests/test_unit*.py tests/test_risk*.py tests/test_fhir*.py \
          --cov=. --cov-report=xml --cov-report=term \
          -v --tb=short -x
      env:
        FLASK_SECRET_KEY: test-secret-key-for-ci-only-not-for-production
        SMART_CLIENT_ID: test-client-id
        SMART_REDIRECT_URI: http://localhost:8080/callback
        TESTING: "true"
      continue-on-error: true
        
    - name: Upload unit test coverage
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-coverage
        path: coverage.xml

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-flask
        
    - name: Create test directories
      run: |
        mkdir -p instance/flask_session
        
    - name: Run integration tests
      run: |
        pytest tests/test_integration*.py tests/test_twcore*.py \
          --cov=. --cov-report=xml --cov-report=term \
          -v --tb=short
      env:
        FLASK_SECRET_KEY: test-secret-key-for-ci-only-not-for-production
        SMART_CLIENT_ID: test-client-id
        SMART_REDIRECT_URI: http://localhost:8080/callback
        TESTING: "true"
      continue-on-error: true
        
    - name: Upload integration test coverage
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-coverage
        path: coverage.xml

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-flask
        
    - name: Create test directories
      run: |
        mkdir -p instance/flask_session
        
    - name: Run E2E tests
      run: |
        pytest tests/test_app_e2e.py \
          --cov=. --cov-report=xml --cov-report=html --cov-report=term \
          -v --tb=short
      env:
        FLASK_SECRET_KEY: test-secret-key-for-ci-only-not-for-production
        SMART_CLIENT_ID: test-client-id
        SMART_REDIRECT_URI: http://localhost:8080/callback
        TESTING: "true"
        
    - name: Upload E2E test coverage
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-coverage
        path: |
          coverage.xml
          htmlcov/

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-flask
        
    - name: Create test directories
      run: |
        mkdir -p instance/flask_session
        
    - name: Run security tests
      run: |
        pytest tests/test_security*.py tests/test_auth*.py tests/test_input_validator*.py tests/test_audit*.py \
          --cov=. --cov-report=xml --cov-report=term \
          -v --tb=short
      env:
        FLASK_SECRET_KEY: test-secret-key-for-ci-only-not-for-production
        SMART_CLIENT_ID: test-client-id
        SMART_REDIRECT_URI: http://localhost:8080/callback
        TESTING: "true"
      continue-on-error: true
        
    - name: Upload security test coverage
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-test-coverage
        path: coverage.xml

  all-tests:
    name: Full Test Suite
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, security-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-flask pytest-html
        
    - name: Create test directories
      run: |
        mkdir -p instance/flask_session
        
    - name: Run all tests with full coverage
      run: |
        pytest tests/ \
          --cov=. --cov-report=xml --cov-report=html --cov-report=term \
          --html=test-report.html --self-contained-html \
          -v --tb=short
      env:
        FLASK_SECRET_KEY: test-secret-key-for-ci-only-not-for-production
        SMART_CLIENT_ID: test-client-id
        SMART_REDIRECT_URI: http://localhost:8080/callback
        TESTING: "true"
        
    - name: Upload full test report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: full-test-report
        path: |
          test-report.html
          coverage.xml
          htmlcov/
          
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: always()
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true
      
    - name: Check coverage threshold
      run: |
        COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); print(float(tree.getroot().attrib['line-rate']) * 100)")
        echo "Current coverage: $COVERAGE%"
        if (( $(echo "$COVERAGE < 25" | bc -l) )); then
          echo "::warning::Coverage is below 25%!"
        fi
      continue-on-error: true

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verify application structure
      run: |
        echo "Checking application files..."
        ls -la
        [ -f APP.py ] || exit 1
        [ -f requirements.txt ] || exit 1
        [ -f Dockerfile ] || exit 1
        echo "âœ… All required files present"
        
    - name: Test application startup
      run: |
        echo "Testing Flask app can initialize..."
        python -c "from APP import app; print('âœ… Flask app initialized successfully')"
      env:
        FLASK_ENV: development
        TESTING: "true"
        FLASK_SECRET_KEY: test-secret-key-for-ci-only-not-for-production
        SMART_CLIENT_ID: test-client-id
        SMART_REDIRECT_URI: http://localhost:8080/callback
        
    - name: Create build artifact
      run: |
        mkdir -p build
        cp -r *.py templates static services requirements.txt Dockerfile build/ 2>/dev/null || true
        tar -czf smart-fhir-app-${{ github.sha }}.tar.gz build/
        
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: smart-fhir-app-build
        path: smart-fhir-app-${{ github.sha }}.tar.gz
        retention-days: 30

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: precise-hbr:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Test Docker image
      run: |
        docker run --rm -d --name test-container \
          -e FLASK_SECRET_KEY=test-key \
          -e SMART_CLIENT_ID=test-id \
          -e SMART_REDIRECT_URI=http://localhost:8080/callback \
          -p 8080:8080 \
          precise-hbr:test || true
        sleep 5
        curl -f http://localhost:8080/health || echo "Health check skipped"
        docker stop test-container || true
      continue-on-error: true

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, all-tests, build, docker-build]
    if: always()
    
    steps:
    - name: Generate build summary
      run: |
        echo "## ðŸ—ï¸ CI Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Author** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Triggered by** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Job Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Code Quality | ${{ needs.code-quality.result == 'success' && 'âœ… Passed' || 'âš ï¸ ' }}${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || 'âš ï¸ ' }}${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| All Tests | ${{ needs.all-tests.result == 'success' && 'âœ… Passed' || 'âŒ ' }}${{ needs.all-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Passed' || 'âŒ ' }}${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Build | ${{ needs.docker-build.result == 'success' && 'âœ… Passed' || 'âš ï¸ ' }}${{ needs.docker-build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Test reports and coverage available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Download from the Actions tab" >> $GITHUB_STEP_SUMMARY
