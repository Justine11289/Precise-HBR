{% extends "layout.html" %}

{% block title %}PRECISE-HBR Bleeding Risk Calculator{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Information Banner -->
    <div class="alert alert-info mb-4" role="alert" aria-live="polite">
        <div class="d-flex align-items-center">
            <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
            <div class="flex-grow-1">
                <strong>PRECISE-HBR Bleeding Risk Calculator</strong> - Evidence-based clinical decision support for
                high bleeding risk assessment in PCI patients.
            </div>
            <div>
                <a href="/landing" target="_blank" class="btn btn-sm btn-outline-primary me-2"
                    aria-label="Learn more about PRECISE-HBR (opens in new window)">
                    <i class="fas fa-external-link-alt" aria-hidden="true"></i> Learn More
                </a>
                <a href="/docs" target="_blank" class="btn btn-sm btn-outline-secondary"
                    aria-label="View documentation (opens in new window)">
                    <i class="fas fa-book" aria-hidden="true"></i> Documentation
                </a>
            </div>
        </div>
    </div>

    <!-- R-04 Risk Mitigation: Enhanced Security Advisory Banner -->
    <div class="alert alert-warning mb-4" role="alert" aria-live="polite">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <i class="fas fa-shield-alt me-2" aria-hidden="true"></i>
                <div>
                    <strong>Security Notice:</strong> You are viewing Protected Health Information (PHI). Please ensure
                    you are on a secure network and be mindful of your surroundings to protect patient privacy.
                </div>
            </div>
            <div class="text-end">
                <small class="text-muted">Session timeout: <span id="session-timer" aria-live="polite"
                        aria-atomic="true">5:00</span></small>
            </div>
        </div>
    </div>

    <div id="loading-container" class="text-center" role="status" aria-live="assertive" aria-atomic="true">
        <div class="spinner-border text-primary" role="status" aria-label="Loading patient data">
            <span class="visually-hidden">Loading patient data, please wait...</span>
        </div>
        <p class="mt-2" id="loading-message">Fetching patient data from FHIR server and calculating risk score, please
            wait...</p>
    </div>

    <div id="error-container" class="alert alert-danger d-none" role="alert" aria-live="assertive" aria-atomic="true">
        <h4><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> Error Calculating Risk</h4>
        <p id="error-message"></p>
        <button class="btn btn-primary reload-btn" aria-label="Retry calculation">
            <i class="fas fa-redo" aria-hidden="true"></i> Retry
        </button>
    </div>

    <div id="results-container" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h3">Bleeding Risk Assessment Results</h2>
            <button class="btn btn-sm btn-outline-secondary reload-btn">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>
        </div>

        <div class="row">
            <!-- Patient Info -->
            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-user-circle"></i> Patient Information</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Patient ID:</strong>
                            <span id="patient-id" class="badge bg-primary text-white">
                                {% if patient_id %}{{ patient_id }}{% else %}Loading...{% endif %}
                            </span>
                        </p>
                        <p><strong>Name:</strong> <span id="patient-name">Loading...</span></p>
                        <p><strong>Age:</strong> <span id="patient-age">Loading...</span></p>
                        <p><strong>Gender:</strong> <span id="patient-gender">Loading...</span></p>
                    </div>
                </div>
            </div>

            <!-- Total Score -->
            <div class="col-md-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-calculator"></i> Total Risk Score</h5>
                        <!-- ONC Compliance: CCD Export Button -->
                        <button id="exportCcdBtn" class="btn btn-sm btn-outline-primary d-none"
                            title="Export results as C-CDA Continuity of Care Document">
                            <i class="fas fa-download"></i> Export CCD
                        </button>
                    </div>
                    <div class="card-body text-center">
                        <h1 id="total-score" class="display-3 fw-bold"></h1>
                        <p id="risk-level" class="h4"></p>
                        <p id="recommendation" class="lead"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- HBR Clinical Recommendations Section (Dynamically shown when HBR detected) -->
        <div class="row d-none" id="hbr-recommendations-section">
            <div class="col-12">
                <div class="alert alert-warning border-warning alert-hbr">
                    <h4 class="mb-3">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <strong>High Bleeding Risk (HBR) Detected</strong>
                    </h4>
                    <p class="mb-3">
                        Based on the PRECISE-HBR score (≥23), this patient has been identified as having <strong>high
                            bleeding risk</strong>.
                        Consider the following antiplatelet strategies to reduce bleeding risk:
                    </p>

                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">💊 Recommended Antiplatelet Strategies (Post-ACS)</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary"><strong>Strategy 1: Abbreviated DAPT</strong></h6>
                                    <ul class="mb-3">
                                        <li><strong>HBR patients only:</strong>
                                            <ul>
                                                <li>1 month DAPT (dual antiplatelet therapy)</li>
                                                <li>Then switch to P2Y₁₂ inhibitor or aspirin monotherapy</li>
                                            </ul>
                                        </li>
                                        <li><strong>HBR and non-HBR patients:</strong>
                                            <ul>
                                                <li>3-6 months DAPT</li>
                                                <li>Then switch to P2Y₁₂ inhibitor or aspirin monotherapy</li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-success"><strong>Strategy 2: DAPT De-escalation</strong></h6>
                                    <ul class="mb-3">
                                        <li><strong>Initial therapy:</strong>
                                            <ul>
                                                <li>Aspirin + Prasugrel, OR</li>
                                                <li>Aspirin + Ticagrelor</li>
                                            </ul>
                                        </li>
                                        <li><strong>At 3 months:</strong>
                                            <ul>
                                                <li>De-escalate: Change from potent P2Y₁₂ inhibitor to clopidogrel</li>
                                                <li>Continue: Aspirin + Clopidogrel</li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div class="alert alert-info mb-3">
                                <strong><i class="fas fa-info-circle"></i> Clinical Guideline:</strong>
                                <p class="mb-2">
                                    These recommendations are based on ESC (European Society of Cardiology) guidelines
                                    for
                                    managing antiplatelet therapy in patients with high bleeding risk after acute
                                    coronary syndrome (ACS).
                                </p>
                            </div>

                            <div class="text-center mt-3">
                                <img src="{{ url_for('static', filename='images/HBR_guideline.jpg') }}"
                                    alt="HBR Antiplatelet Strategy Guideline"
                                    class="img-fluid rounded shadow guideline-img hbr-guideline-img">
                                <p class="text-muted mt-2">
                                    <small>Click image to view full size | Source: ESC Guidelines</small>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-danger mb-0">
                        <strong><i class="fas fa-shield-exclamation"></i> Important Note:</strong>
                        <p class="mb-0">
                            These are general recommendations based on clinical guidelines. <strong>Always consult with
                                the treating physician</strong>
                            before making any changes to antiplatelet therapy. Individual patient factors, concomitant
                            medications,
                            and clinical context must be considered.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Missing Data Warning -->
        <div id="missing-data-warning" class="alert alert-warning mb-4 d-none" role="alert" aria-live="polite">
            <div class="d-flex align-items-start">
                <i class="fas fa-exclamation-triangle me-3 mt-1 font-size-1-5rem" aria-hidden="true"></i>
                <div class="flex-grow-1">
                    <h5 class="alert-heading mb-2">
                        <strong>⚠️ Missing Data Detected - Risk May Be Underestimated</strong>
                    </h5>
                    <p class="mb-2">
                        The following important risk factors have missing data. The calculated bleeding risk score may
                        be <strong>lower than the actual risk</strong>.
                    </p>
                    <ul id="missing-data-list" class="mb-2 missing-list">
                        <!-- Missing data items will be inserted here by JavaScript -->
                    </ul>
                    <p class="mb-0 text-muted">
                        <i class="fas fa-info-circle"></i>
                        <small>Please manually enter the missing values in the table below if available, or interpret
                            results with caution.</small>
                    </p>
                </div>
            </div>
        </div>

        <!-- Score Breakdown -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list-ul" aria-hidden="true"></i> Score Components</h5>
            </div>
            <div class="card-body">
                <table class="table table-hover align-middle font-xxl" role="table" aria-label="Risk score components">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" class="table-th-35">Risk Factor</th>
                            <th scope="col" class="table-th-40">Value (Editable)</th>
                            <th scope="col" class="table-th-10">Score</th>
                            <th scope="col" class="table-th-15">Date</th>
                        </tr>
                    </thead>
                    <tbody id="score-components">
                        <!-- Interactive components will be inserted here by JavaScript -->
                    </tbody>
                </table>
                <div class="form-text mt-2" role="note" aria-label="Editing instructions">
                    <i class="fas fa-info-circle" aria-hidden="true"></i>
                    You can manually edit the values in the table above to perform a "what-if" analysis. The total score
                    will update automatically.
                </div>
            </div>
        </div>

        <!-- User Feedback Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-comment-dots mr-2"></i>
                    Result Feedback
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Do you think this bleeding risk calculation result is accurate? Please share
                    your feedback:</p>
                <div id="feedbackSection">
                    <div class="d-flex justify-content-center mb-3">
                        <button type="button" id="thumbsUpBtn" class="btn btn-outline-success btn-lg mx-2"
                            title="Result is accurate">
                            <i class="fas fa-thumbs-up mr-2"></i>
                            Accurate
                        </button>
                        <button type="button" id="thumbsDownBtn" class="btn btn-outline-danger btn-lg mx-2"
                            title="Result is not accurate">
                            <i class="fas fa-thumbs-down mr-2"></i>
                            Not Accurate
                        </button>
                    </div>

                    <!-- Optional Comment Section (Initially Hidden) -->
                    <div id="commentSection" class="mt-3 d-none">
                        <div class="form-group">
                            <label for="feedbackComment">
                                <i class="fas fa-comment mr-1"></i>
                                Additional Comments (Optional):
                            </label>
                            <textarea id="feedbackComment" class="form-control" rows="3"
                                placeholder="Please share your specific feedback or suggestions about the calculation result..."></textarea>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" id="cancelFeedbackBtn" class="btn btn-secondary mr-2">
                                Cancel
                            </button>
                            <button type="button" id="submitCommentBtn" class="btn btn-primary">
                                <i class="fas fa-paper-plane mr-1"></i>
                                Submit Feedback
                            </button>
                        </div>
                    </div>

                    <!-- Feedback Success Message -->
                    <div id="feedbackSuccess" class="alert alert-success mt-3 d-none">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span id="feedbackMessage">Thank you for your feedback!</span>
                    </div>

                    <!-- Feedback Error Message -->
                    <div id="feedbackError" class="alert alert-danger mt-3 d-none">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        An error occurred while submitting feedback, please try again later.
                    </div>
                </div>
            </div>
        </div>

        <!-- ARC-HBR Guideline Image -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-image mr-2"></i>
                    ARC-HBR Guideline Reference
                </h5>
            </div>
            <div class="card-body text-center">
                <img src="{{ url_for('static', filename='images/ARCHBR.png') }}" alt="ARC-HBR Guideline"
                    class="img-fluid arc-guideline-img">
            </div>
        </div>

        <!-- Citation Information -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-book mr-2"></i>
                    Citation
                </h5>
            </div>
            <div class="card-body">
                <div class="citation-box">
                    <p class="mb-1"><strong>Article Type:</strong> Journal Article</p>
                    <p class="mb-1"><strong>Title:</strong> Derivation and Validation of the PRECISE-HBR Score to
                        Predict Bleeding After Percutaneous Coronary Intervention</p>
                    <p class="mb-1"><strong>Authors:</strong> Gragnano, Felice; van Klaveren, David; Heg, Dik; Räber,
                        Lorenz; Krucoff, Mitchell W.; Raposeiras-Roubín, Sergio; ten Berg, Jurriën M.; Leonardi, Sergio;
                        Kimura, Takeshi; Corpataux, Noé; Spirito, Alessandro; Hermiller, James B.; Abu-Assi, Emad; Chan
                        Pin Yin, Dean; Azzahhafi, Jaouad; Montalto, Claudio; Galazzi, Marco; Bär, Sarah; Kavaliauskaite,
                        Raminta; D'Ascenzo, Fabrizio; De Ferrari, Gaetano M.; Watanabe, Hirotoshi; Steg, Philippe
                        Gabriel; Bhatt, Deepak L.; Calabrò, Paolo; Mehran, Roxana; Urban, Philip; Pocock, Stuart;
                        Windecker, Stephan; Valgimigli, Marco</p>
                    <p class="mb-1"><strong>Journal:</strong> Circulation</p>
                    <p class="mb-1"><strong>Year:</strong> 2025</p>
                    <p class="mb-1"><strong>Date:</strong> 2025/02/11</p>
                    <p class="mb-1"><strong>Volume:</strong> 151</p>
                    <p class="mb-1"><strong>Issue:</strong> 6</p>
                    <p class="mb-1"><strong>Pages:</strong> 343-355</p>
                    <p class="mb-1"><strong>Publisher:</strong> American Heart Association</p>
                    <p class="mb-1"><strong>DOI:</strong> <a href="https://doi.org/10.1161/CIRCULATIONAHA.124.072009"
                            target="_blank" rel="noopener noreferrer">10.1161/CIRCULATIONAHA.124.072009</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables for feedback system
    let currentFeedbackType = null;
    let currentPatientData = null;
    let scoreComponentData = []; // Store the component data globally

    // === NEW: Unit conversion tracking ===
    let unitSettings = {
        hemoglobin: 'g/dL',  // or 'mmol/L'
        // Can add more units as needed
    };

    // === NEW: Clinical tooltips data ===
    const clinicalTooltips = {
        'Age': {
            title: 'Age',
            content: 'Age is a continuous variable in the PRECISE-HBR model. It is truncated to the 30-80 years range during calculation; older age increases the score.',
            normalRange: 'Calculation Range: 30-80 years',
            riskFactors: 'Score Weight: +0.25 points per year increase<br>Example: 65 years = (65-30) × 0.25 = 8.75 points'
        },
        'Hemoglobin': {
            title: 'Hemoglobin',
            content: 'Hemoglobin is a continuous variable in the PRECISE-HBR model. It is truncated to the 5-15 g/dL range during calculation; lower hemoglobin increases the score.',
            normalRange: 'Calculation Range: 5-15 g/dL',
            riskFactors: 'Score Weight: +2.5 points per 1 g/dL decrease<br>Example: 12 g/dL = (15-12) × 2.5 = 7.5 points'
        },
        'eGFR': {
            title: 'eGFR (Estimated Glomerular Filtration Rate)',
            content: 'eGFR is a continuous variable in the PRECISE-HBR model. It is truncated to the 5-100 mL/min range; lower kidney function increases the score.',
            normalRange: 'Calculation Range: 5-100 mL/min/1.73m²',
            riskFactors: 'Score Weight: +0.05 points per 1 mL/min decrease<br>Example: 60 mL/min = (100-60) × 0.05 = 2.0 points'
        },
        'White Blood Cell': {
            title: 'White Blood Cell',
            content: 'WBC count is a continuous variable in the PRECISE-HBR model. It is truncated to a maximum of 15 ×10⁹/L; higher WBC increases the score.',
            normalRange: 'Calculation Range: 0-15 ×10⁹/L',
            riskFactors: 'Score Weight: +0.5 points per 1 ×10⁹/L increase<br>Example: 10 ×10⁹/L = 10 × 0.5 = 5.0 points'
        },
        'White Blood Cell Count': {
            title: 'White Blood Cell Count',
            content: 'WBC count is a continuous variable in the PRECISE-HBR model. It is truncated to a maximum of 15 ×10⁹/L; higher WBC increases the score.',
            normalRange: 'Calculation Range: 0-15 ×10⁹/L',
            riskFactors: 'Score Weight: +0.5 points per 1 ×10⁹/L increase<br>Example: 10 ×10⁹/L = 10 × 0.5 = 5.0 points'
        },
        'Previous bleeding': {
            title: 'Previous Bleeding',
            content: 'History of spontaneous bleeding is the strongest predictor of future bleeding. Includes gastrointestinal bleeding, intracranial hemorrhage, or bleeding requiring transfusion.',
            normalRange: 'No history of bleeding',
            riskFactors: 'Significant risk increase for those with history (+7 points)'
        },
        'Long-term OAC': {
            title: 'Long-term Oral Anticoagulation',
            content: 'Long-term use of oral anticoagulants (e.g., Warfarin, DOACs) significantly increases bleeding risk, especially when combined with antiplatelet therapy.',
            normalRange: 'Not used',
            riskFactors: 'Doubles the bleeding risk (+5 points)'
        },
        'Long-term oral anticoagulation': {
            title: 'Long-term Oral Anticoagulation',
            content: 'Long-term use of oral anticoagulants (e.g., Warfarin, DOACs) significantly increases bleeding risk. Bleeding risk is further elevated when used with dual or triple antiplatelet therapy.',
            normalRange: 'Not used',
            riskFactors: 'ARC-HBR Major Criterion'
        },
        'Platelet count': {
            title: 'Platelet Count',
            content: 'Platelets are key for coagulation. Low platelet count (<100×10⁹/L) impairs clotting ability, increasing risk of spontaneous and post-traumatic bleeding. Can be caused by marrow disease, hypersplenism, or medications.',
            normalRange: '150-400 ×10⁹/L',
            riskFactors: '<100 ×10⁹/L is an ARC-HBR Major Criterion<br><50 ×10⁹/L is severe thrombocytopenia'
        },
        'Platelet count <100': {
            title: 'Platelet Count <100 ×10⁹/L (Thrombocytopenia)',
            content: 'Platelets are key for coagulation. Low platelet count (<100×10⁹/L) impairs clotting ability, increasing risk of spontaneous and post-traumatic bleeding.',
            normalRange: '150-400 ×10⁹/L',
            riskFactors: '<100 ×10⁹/L is an ARC-HBR Major Criterion'
        },
        'Chronic bleeding diathesis': {
            title: 'Chronic Bleeding Diathesis',
            content: 'Refers to congenital or acquired coagulation disorders, such as Hemophilia, von Willebrand disease, etc. These patients have inherent clotting defects, and antiplatelet therapy further increases risk.',
            normalRange: 'No coagulation disorder',
            riskFactors: 'ARC-HBR Major Criterion<br>Includes: Hemophilia, von Willebrand disease, Factor deficiency'
        },
        'Liver cirrhosis': {
            title: 'Liver Cirrhosis with Portal Hypertension',
            content: 'Cirrhosis reduces coagulation factor synthesis, while portal hypertension causes esophageal varices and hypersplenism (low platelets). Together, these significantly increase risk of major GI bleeding.',
            normalRange: 'No cirrhosis',
            riskFactors: 'ARC-HBR Major Criterion<br>Mortality from variceal bleeding is 20-30%'
        },
        'Active malignancy': {
            title: 'Active Malignancy',
            content: 'Active cancer (diagnosed or treated within past 12 months, excluding non-melanoma skin cancer) increases bleeding risk. The tumor itself, chemotherapy, and radiation can affect coagulation and platelets.',
            normalRange: 'No active malignancy',
            riskFactors: 'ARC-HBR Major Criterion<br>Risk depends on tumor type, stage, and treatment'
        },
        'Chronic use of nsaids': {
            title: 'Chronic Use of NSAIDs or Corticosteroids',
            content: 'NSAIDs inhibit platelet function and damage gastric mucosa, increasing GI bleeding risk. Long-term steroids weaken vessel walls. Risk is additive when combined with antiplatelet drugs.',
            normalRange: 'No chronic use',
            riskFactors: 'ARC-HBR Minor Criterion<br>Includes: ibuprofen, naproxen, steroids, etc.'
        },
        'Anemia': {
            title: 'Anemia',
            content: 'Anemia (Hb <11 g/dL) may indicate chronic bleeding and reduces tolerance to bleeding complications. Anemic patients are more prone to hemodynamic instability if bleeding occurs.',
            normalRange: 'Hb ≥13 g/dL (Male), ≥12 g/dL (Female)',
            riskFactors: 'Hb <11 g/dL is an ARC-HBR Minor Criterion'
        },
        'Chronic kidney disease': {
            title: 'Chronic Kidney Disease',
            content: 'CKD (eGFR <60 mL/min) affects platelet function and coagulation factor metabolism. Also, many antithrombotics are renally cleared; impairment leads to accumulation and bleeding.',
            normalRange: 'eGFR ≥60 mL/min/1.73m²',
            riskFactors: 'eGFR <60 is an ARC-HBR Minor Criterion<br>eGFR <30 is a Major Criterion'
        },
        'Thrombocytopenia': {
            title: 'Thrombocytopenia',
            content: 'Low platelet count affects primary hemostasis. Moderate thrombocytopenia (<100×10⁹/L) may increase bleeding risk, especially during invasive procedures or antithrombotic therapy.',
            normalRange: '150-400 ×10⁹/L',
            riskFactors: '<100 ×10⁹/L is an ARC-HBR Major Criterion'
        }
    };

    // R-04 Risk Mitigation: Session timeout functionality
    let sessionTimeoutMinutes = 5; // 5 minutes timeout
    let sessionTimer = sessionTimeoutMinutes * 60; // Convert to seconds
    let sessionInterval;

    function startSessionTimer() {
        sessionInterval = setInterval(function () {
            sessionTimer--;

            // Update display
            const minutes = Math.floor(sessionTimer / 60);
            const seconds = sessionTimer % 60;
            document.getElementById('session-timer').textContent =
                `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Warning at 1 minute
            if (sessionTimer === 60) {
                showSessionWarning();
            }

            // Auto logout at 0
            if (sessionTimer <= 0) {
                autoLogout();
            }
        }, 1000);
    }

    function showSessionWarning() {
        const warningDiv = document.createElement('div');
        warningDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed session-warning-popup';
        warningDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Session Warning:</strong> Your session will expire in 1 minute due to inactivity. 
            <button onclick="extendSession()" class="btn btn-sm btn-light ms-2">Extend Session</button>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(warningDiv);

        // Auto-remove after 10 seconds if not dismissed
        setTimeout(() => {
            if (warningDiv.parentNode) {
                warningDiv.remove();
            }
        }, 10000);
    }

    function extendSession() {
        sessionTimer = sessionTimeoutMinutes * 60; // Reset timer
        document.querySelectorAll('.alert-danger').forEach(alert => {
            if (alert.textContent.includes('Session Warning')) {
                alert.remove();
            }
        });
    }

    function autoLogout() {
        clearInterval(sessionInterval);
        alert('Your session has expired for security reasons. You will be logged out.');
        window.location.href = '/logout';
    }

    // Reset timer on user activity
    function resetSessionTimer() {
        if (sessionTimer > 0) {
            sessionTimer = sessionTimeoutMinutes * 60;
        }
    }

    // Listen for user activity
    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
        document.addEventListener(event, resetSessionTimer, { passive: true });
    });

    document.addEventListener("DOMContentLoaded", function () {
        // Start session timer
        startSessionTimer();

        // Setup all event listeners (CSP compliance)
        setupEventListeners();

        // The patient_id is rendered into the template from the session by Flask
        const patientId = "{{ patient_id }}";
        if (patientId && patientId !== 'N/A') {
            fetchRiskData(patientId);
        } else {
            console.error("Patient ID not found in template. Cannot fetch risk data.");
            displayError("Could not identify the patient. Please try launching the app again.");
        }
    });

    function setupEventListeners() {
        // Static buttons
        document.getElementById('thumbsUpBtn')?.addEventListener('click', () => submitFeedback('thumbs_up'));
        document.getElementById('thumbsDownBtn')?.addEventListener('click', () => submitFeedback('thumbs_down'));
        document.getElementById('submitCommentBtn')?.addEventListener('click', submitComment);
        document.getElementById('cancelFeedbackBtn')?.addEventListener('click', cancelFeedback);
        document.getElementById('exportCcdBtn')?.addEventListener('click', exportCCD);

        // Reload buttons
        document.querySelectorAll('.reload-btn').forEach(btn => {
            btn.addEventListener('click', () => window.location.reload());
        });

        // Guideline Image
        document.querySelectorAll('.guideline-img').forEach(img => {
            img.addEventListener('click', (e) => window.open(e.target.src, '_blank'));
        });

        // Dynamic Table Delegation
        const tableBody = document.getElementById('score-components');
        if (tableBody) {
            tableBody.addEventListener('input', (e) => {
                const target = e.target;
                if (target.tagName === 'INPUT' && target.type === 'number') {
                    // Extract parameter name from ID "input-Parameter Name"
                    const id = target.id;
                    if (id && id.startsWith('input-')) {
                        const param = id.substring(6);
                        handleValueInput(param, target);
                    }
                }
            });
            tableBody.addEventListener('change', (e) => {
                if (e.target.tagName === 'INPUT' && e.target.type === 'checkbox') {
                    recalculateAndRefreshUI();
                }
            });
            // Click delegation for unit toggle buttons
            tableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('unit-toggle-btn')) {
                    const inputGroup = e.target.closest('.input-group');
                    const input = inputGroup?.querySelector('input');
                    if (input) toggleHemoglobinUnit(input);
                }
            });
        }
    }

    async function fetchRiskData(patientId) {
        document.getElementById('loading-container').classList.remove('d-none');
        document.getElementById('results-container').classList.add('d-none');
        document.getElementById('error-container').classList.add('d-none');
        try {
            const response = await fetch('/api/calculate_risk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ patientId: patientId })
            });

            const data = await response.json();
            console.log(">>> 成功從 API 取得資料:", data); 

            // 3. 確保資料狀態是 success 才渲染
            if (data.status === 'success') {
                displayResults(data);
            } else {
                // 🛡️ 關鍵修正：使用從後端傳回的 data.patient_info 而非未定義的變數
                if (data.patient_info) {
                    renderBasicPatientInfo(data.patient_info);
                }
                throw new Error(data.error || "計算風險時發生未知錯誤");
            }
        } catch (error) {
            console.error('Error fetching risk data:', error);
            displayError(error.message);
        }
    }
    function renderBasicPatientInfo(info) {
        if (!info) return;
        
        // 定位 DOM 元素並渲染
        const idEl = document.getElementById('patient-id');
        const nameEl = document.getElementById('patient-name');
        const ageEl = document.getElementById('patient-age');
        const genderEl = document.getElementById('patient-gender');

        if (idEl) idEl.textContent = info.patient_id || info.id || 'N/A';
        if (nameEl) nameEl.textContent = info.name || 'N/A';
        if (ageEl) ageEl.textContent = info.age !== null && info.age !== undefined ? info.age : 'N/A';
        if (genderEl) genderEl.textContent = info.gender || 'N/A';
        
        // 即使計算失敗，也顯示已載入的病人資訊區塊
        document.getElementById('loading-container').classList.add('d-none');
        document.getElementById('results-container').classList.remove('d-none');
    }

    function displayResults(data) {
        currentPatientData = data;
        // 確保組件資料永遠是陣列
        scoreComponentData = data.score_components || []; 

        // 呼叫渲染函式
        renderBasicPatientInfo(data.patient_info);

        // 渲染剩餘的 UI 組件
        renderInteractiveTable();
        recalculateAndRefreshUI();
    }

    function getUnitForParameter(parameterName) {
        // Return the appropriate unit based on parameter name
        if (parameterName.includes("Age")) return "years";
        if (parameterName.includes("Hemoglobin")) {
            return unitSettings.hemoglobin || "g/dL";
        }
        if (parameterName.includes("eGFR")) return "mL/min/1.73m²";
        if (parameterName.includes("White Blood Cell")) return "×10⁹/L";
        return "";
    }

    // === NEW: Unit Conversion Functions ===
    function convertHemoglobin(value, fromUnit, toUnit) {
        // Hemoglobin conversion: g/dL ⇄ mmol/L
        // 1 g/dL = 0.6206 mmol/L
        if (fromUnit === toUnit) return value;

        if (fromUnit === 'g/dL' && toUnit === 'mmol/L') {
            return value * 0.6206;
        } else if (fromUnit === 'mmol/L' && toUnit === 'g/dL') {
            return value / 0.6206;
        }
        return value;
    }

    function toggleHemoglobinUnit(inputElement) {
        const currentValue = parseFloat(inputElement.value);
        if (isNaN(currentValue)) return;

        const currentUnit = unitSettings.hemoglobin;
        const newUnit = currentUnit === 'g/dL' ? 'mmol/L' : 'g/dL';

        // Convert value
        const newValue = convertHemoglobin(currentValue, currentUnit, newUnit);

        // Update
        inputElement.value = newValue.toFixed(2);
        unitSettings.hemoglobin = newUnit;

        // Update unit display
        const unitSpan = inputElement.closest('.input-group').querySelector('.input-group-text');
        if (unitSpan) {
            unitSpan.textContent = newUnit;
        }

        // Recalculate
        recalculateAndRefreshUI();
    }

    // === ENHANCED: Value Validation Functions with Clinical Bounds ===
    // Clinical validation ranges based on physiologically plausible values
    const VALIDATION_RANGES = {
        Age: { absoluteMin: 0, absoluteMax: 120, warningMin: 18, warningMax: 100, errorMin: 1, errorMax: 120 },
        Hemoglobin: { absoluteMin: 1, absoluteMax: 25, warningMin: 7, warningMax: 18, errorMin: 3, errorMax: 22 },
        eGFR: { absoluteMin: 0, absoluteMax: 200, warningMin: 15, warningMax: 150, errorMin: 0, errorMax: 180 },
        WBC: { absoluteMin: 0, absoluteMax: 100, warningMin: 4, warningMax: 20, errorMin: 0.1, errorMax: 50 },
        Platelet: { absoluteMin: 0, absoluteMax: 2000, warningMin: 100, warningMax: 450, errorMin: 5, errorMax: 1000 }
    };

    function validateValue(parameterName, value) {
        const numValue = parseFloat(value);
        if (isNaN(numValue)) return { valid: true, level: 'normal', message: '', blockCalculation: false };

        let result = { valid: true, level: 'normal', message: '', blockCalculation: false };

        if (parameterName.includes("Age")) {
            const range = VALIDATION_RANGES.Age;
            if (numValue < range.absoluteMin || numValue > range.absoluteMax) {
                result.level = 'error';
                result.message = `Age must be between ${range.absoluteMin} and ${range.absoluteMax} years`;
                result.blockCalculation = true;
            } else if (numValue < range.warningMin) {
                result.level = 'error';
                result.message = 'Age must be ≥ 18 for adult risk calculation';
                result.blockCalculation = true;
            } else if (numValue > range.warningMax) {
                result.level = 'warning';
                result.message = 'Age exceeds typical range (>100 years)';
            } else if (numValue >= 75) {
                result.level = 'warning';
                result.message = 'Elderly patient (≥75 years) - increased bleeding risk';
            }
        } else if (parameterName.includes("Hemoglobin")) {
            const range = VALIDATION_RANGES.Hemoglobin;
            const unit = unitSettings.hemoglobin || 'g/dL';

            // Convert mmol/L limits if needed (1 g/dL = 0.6206 mmol/L)
            let effectiveMin = range.absoluteMin;
            let effectiveMax = range.absoluteMax;
            let errorMin = range.errorMin;
            let errorMax = range.errorMax;

            if (unit === 'mmol/L') {
                effectiveMin = range.absoluteMin * 0.6206;
                effectiveMax = range.absoluteMax * 0.6206;
                errorMin = range.errorMin * 0.6206;
                errorMax = range.errorMax * 0.6206;
            }

            if (numValue < effectiveMin || numValue > effectiveMax) {
                result.level = 'error';
                result.message = `Hemoglobin must be between ${effectiveMin.toFixed(1)} and ${effectiveMax.toFixed(1)} ${unit}`;
                result.blockCalculation = true;
            } else if (numValue < errorMin) {
                result.level = 'error';
                result.message = `Critically low hemoglobin (<${errorMin.toFixed(1)} ${unit}) - Value may be incorrect`;
                result.blockCalculation = true;
            } else if (numValue > errorMax) {
                result.level = 'error';
                result.message = `Hemoglobin too high (>${errorMax.toFixed(1)} ${unit}) - Please verify`;
                result.blockCalculation = true;
            } else if (unit === 'g/dL') {
                if (numValue < 11) {
                    result.level = 'warning';
                    result.message = 'Anemia (<11 g/dL) - Increased bleeding risk';
                } else if (numValue < 13) {
                    result.level = 'warning';
                    result.message = 'Mild anemia (11-13 g/dL)';
                } else if (numValue > 18) {
                    result.level = 'warning';
                    result.message = 'Elevated hemoglobin (>18 g/dL)';
                }
            }
        } else if (parameterName.includes("eGFR")) {
            const range = VALIDATION_RANGES.eGFR;
            if (numValue < range.absoluteMin) {
                result.level = 'error';
                result.message = 'eGFR cannot be negative';
                result.blockCalculation = true;
            } else if (numValue > range.absoluteMax) {
                result.level = 'error';
                result.message = `eGFR exceeds maximum plausible value (>${range.absoluteMax})`;
                result.blockCalculation = true;
            } else if (numValue < 15) {
                result.level = 'warning';
                result.message = 'Severe renal impairment (<15) - Very high risk';
            } else if (numValue < 30) {
                result.level = 'warning';
                result.message = 'Severe renal impairment (<30) - High risk';
            } else if (numValue < 60) {
                result.level = 'warning';
                result.message = 'Moderate renal impairment (30-60)';
            } else if (numValue > range.warningMax) {
                result.level = 'warning';
                result.message = 'eGFR unusually high (>150) - Please verify';
            }
        } else if (parameterName.includes("White Blood Cell")) {
            const range = VALIDATION_RANGES.WBC;
            if (numValue < range.absoluteMin) {
                result.level = 'error';
                result.message = 'WBC cannot be negative';
                result.blockCalculation = true;
            } else if (numValue > range.absoluteMax) {
                result.level = 'error';
                result.message = `WBC exceeds maximum plausible value (>${range.absoluteMax} ×10⁹/L)`;
                result.blockCalculation = true;
            } else if (numValue < range.errorMin) {
                result.level = 'error';
                result.message = 'Critically low WBC - Value may be incorrect';
                result.blockCalculation = true;
            } else if (numValue > range.errorMax) {
                result.level = 'error';
                result.message = `Extremely high WBC (>${range.errorMax}) - Please verify`;
                result.blockCalculation = true;
            } else if (numValue < range.warningMin) {
                result.level = 'warning';
                result.message = 'Low WBC (<4 ×10⁹/L) - Leukopenia';
            } else if (numValue > range.warningMax) {
                result.level = 'warning';
                result.message = 'Elevated WBC (>20 ×10⁹/L) - Leukocytosis';
            }
        } else if (parameterName.includes("Platelet")) {
            const range = VALIDATION_RANGES.Platelet;
            if (numValue < range.absoluteMin) {
                result.level = 'error';
                result.message = 'Platelet count cannot be negative';
                result.blockCalculation = true;
            } else if (numValue > range.absoluteMax) {
                result.level = 'error';
                result.message = `Platelet count exceeds maximum (>${range.absoluteMax} ×10⁹/L)`;
                result.blockCalculation = true;
            } else if (numValue < range.errorMin) {
                result.level = 'error';
                result.message = 'Critically low platelet - Value may be incorrect';
                result.blockCalculation = true;
            } else if (numValue > range.errorMax) {
                result.level = 'error';
                result.message = `Extremely high platelet (>${range.errorMax}) - Please verify`;
                result.blockCalculation = true;
            } else if (numValue < range.warningMin) {
                result.level = 'warning';
                result.message = 'Thrombocytopenia (<100 ×10⁹/L) - High bleeding risk';
            } else if (numValue > range.warningMax) {
                result.level = 'warning';
                result.message = 'Thrombocytosis (>450 ×10⁹/L)';
            }
        }

        return result;
    }

    // Check all inputs for validation errors that should block calculation
    function hasValidationErrors() {
        let errors = [];

        scoreComponentData.forEach(item => {
            const inputElement = document.getElementById(`input-${item.parameter}`);
            if (inputElement && inputElement.type === 'number' && inputElement.value) {
                const validation = validateValue(item.parameter, inputElement.value);
                if (validation.blockCalculation) {
                    errors.push({
                        parameter: item.parameter,
                        message: validation.message
                    });
                }
            }
        });

        return errors;
    }


    function applyValidationStyling(inputElement, validation) {
        // Remove all validation classes
        inputElement.classList.remove('value-normal', 'value-warning', 'value-error');

        // Apply appropriate class
        if (validation.level === 'error') {
            inputElement.classList.add('value-error');
        } else if (validation.level === 'warning') {
            inputElement.classList.add('value-warning');
        } else {
            inputElement.classList.add('value-normal');
        }

        // Show/hide validation message
        const inputGroup = inputElement.closest('.input-group') || inputElement.parentElement;
        const container = inputGroup.parentElement;

        // First, remove any existing validation messages for this input
        const existingMessages = container.querySelectorAll('.validation-message');
        existingMessages.forEach(msg => msg.remove());

        // Then create new message if needed
        if (validation.message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'validation-message';
            messageDiv.textContent = validation.message;
            if (validation.level === 'error') messageDiv.classList.add('text-danger');
            if (validation.level === 'warning') messageDiv.classList.add('text-warning');
            container.appendChild(messageDiv);
        }
    }

    // === NEW: Generate Tooltip HTML ===
    function generateTooltip(parameterKey) {
        const tooltip = clinicalTooltips[parameterKey];
        if (!tooltip) return '';

        return `
            <span class="info-tooltip">
                <i class="fas fa-info-circle"></i>
                <span class="tooltip-content">
                    <strong>${tooltip.title}</strong><br><br>
                    ${tooltip.content}<br><br>
                    <strong>Normal Range:</strong><br>${tooltip.normalRange}<br><br>
                    <strong>Risk Factors:</strong><br>${tooltip.riskFactors}
                </span>
            </span>
        `;
    }

    function formatValueWithUnit(value, unit) {
        // Format the value nicely with appropriate decimal places
        if (typeof value === 'number') {
            if (unit === "years") return Math.round(value);
            if (unit === "g/dL" || unit === "mmol/L") return value.toFixed(2);
            if (unit === "mL/min/1.73m²") return Math.round(value);
            if (unit === "×10⁹/L") return value.toFixed(2);
            return value.toFixed(2);
        }
        return value;
    }

    // === NEW: Handle input with validation ===
    function handleValueInput(parameterName, inputElement) {
        // Validate the input
        const validation = validateValue(parameterName, inputElement.value);

        // Apply styling based on validation
        applyValidationStyling(inputElement, validation);

        // Recalculate risk
        recalculateAndRefreshUI();
    }

    function renderInteractiveTable() {
        const componentsBody = document.getElementById('score-components');
        componentsBody.innerHTML = ''; // Clear previous content

        // Track missing data for warning display
        let missingDataItems = [];

        if (scoreComponentData && scoreComponentData.length > 0) {
            scoreComponentData.forEach(item => {
                // Skip Base Score - don't display it
                if (item.parameter && item.parameter.includes("Base Score")) {
                    return;
                }

                const cleanParameterName = translateParameterName(item.parameter || 'Unnamed Criterion');
                let valueControl = '';
                const unit = getUnitForParameter(item.parameter);

                // Check if this is missing data
                const isMissingData = (item.value === 'Not available' || item.value === 'N/A' ||
                    (item.raw_value === null && item.is_present === null));

                // Create an input for numbers, a checkbox for booleans, or manual input for missing data
                if (item.raw_value !== null && typeof item.raw_value === 'number') {
                    const formattedValue = formatValueWithUnit(item.raw_value, unit);
                    const step = unit === "years" ? "1" : "0.01";

                    // Add unit toggle button for Hemoglobin
                    const unitToggleBtn = item.parameter.includes("Hemoglobin") ?
                        `<button type="button" class="unit-toggle-btn" title="Toggle Unit">⇄</button>` : '';

                    valueControl = `
                        <div class="input-group input-group-lg-text">
                            <input type="number" 
                                   class="form-control input-number-lg" 
                                   id="input-${item.parameter}" 
                                   value="${formattedValue}" 
                                   step="${step}">
                            ${unit ? `<span class="input-group-text input-unit-lg">${unit}</span>` : ''}
                            ${unitToggleBtn}
                        </div>
                    `;
                } else if (item.is_present !== null && typeof item.is_present === 'boolean') {
                    const checked = item.is_present ? 'checked' : '';
                    // Check if this is an ARC-HBR element (should not have editable score)
                    const isArcElement = item.is_arc_hbr_element === true;
                    valueControl = `
                        <div class="form-check form-switch">
                            <input class="form-check-input form-switch-lg" 
                                   type="checkbox" 
                                   id="input-${item.parameter}" 
                                   ${checked} 
                                   data-is-arc-element="${isArcElement}">
                            <label class="form-check-label form-check-label-lg" 
                                   for="input-${item.parameter}">
                                ${item.value}
                            </label>
                        </div>
                    `;
                } else if (isMissingData) {
                    // Missing data - provide manual input option
                    missingDataItems.push(cleanParameterName);
                    const step = unit === "years" ? "1" : "0.01";
                    const placeholder = unit ? `Enter value in ${unit}` : "Enter value";

                    // Add unit toggle button for Hemoglobin
                    const unitToggleBtn = item.parameter.includes("Hemoglobin") ?
                        `<button type="button" class="unit-toggle-btn" title="Toggle Unit">⇄</button>` : '';

                    valueControl = `
                        <div class="input-group input-group-lg-text">
                            <input type="number" 
                                   class="form-control input-missing" 
                                   id="input-${item.parameter}" 
                                   placeholder="${placeholder}" 
                                   step="${step}"
                                   data-missing="true">
                            ${unit ? `<span class="input-group-text unit-missing">${unit}</span>` : ''}
                            <span class="input-group-text icon-missing">
                                <i class="fas fa-exclamation-triangle text-warning" title="Missing data - please enter manually if available"></i>
                            </span>
                            ${unitToggleBtn}
                        </div>
                    `;
                } else {
                    valueControl = `<span class="font-weight-500 font-lg">${item.value}</span>`; // Fallback for base score or others
                }

                // Generate score badge cell - hide for ARC-HBR elements
                let scoreBadgeHtml = '';
                if (item.is_arc_hbr_element === true) {
                    // Don't show score for ARC-HBR elements
                    scoreBadgeHtml = '<span class="text-muted arc-badge-placeholder">—</span>';
                } else {
                    scoreBadgeHtml = `<span class="badge bg-primary score-badge" id="score-${item.parameter}">${item.score}</span>`;
                }

                // Generate tooltip for clinical information
                const tooltipKey = cleanParameterName.split('(')[0].trim();
                const tooltipHtml = generateTooltip(tooltipKey);

                const row = `
                    <tr>
                        <td class="table-cell-lg">
                            ${cleanParameterName}
                            ${tooltipHtml}
                        </td>
                        <td>${valueControl}</td>
                        <td>${scoreBadgeHtml}</td>
                        <td class="table-cell-lg ${item.is_outdated ? 'text-danger' : ''}">
                            ${item.date || 'N/A'}
                            ${item.is_outdated ? '<br><small><i class="fas fa-exclamation-circle"></i> Please Retest</small>' : ''}
                        </td>
                    </tr>
                `;
                componentsBody.innerHTML += row;
            });

            // Display missing data warning if any
            displayMissingDataWarning(missingDataItems);
        } else {
            const row = `<tr><td colspan="4" class="text-center">No risk components available for editing.</td></tr>`;
            componentsBody.innerHTML = row;
        }
    }

    function displayMissingDataWarning(missingItems) {
        const warningDiv = document.getElementById('missing-data-warning');
        const missingList = document.getElementById('missing-data-list');

        if (missingItems && missingItems.length > 0) {
            // Build the list of missing items
            missingList.innerHTML = '';
            missingItems.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                li.className = 'missing-list-item';
                missingList.appendChild(li);
            });

            // Show the warning
            warningDiv.classList.remove('d-none');
        } else {
            // Hide the warning if no missing data
            warningDiv.classList.add('d-none');
        }
    }

    function recalculateAndRefreshUI() {
        // Check for critical data before calculating
        const requiredParameters = ['Age', 'Hemoglobin', 'eGFR', 'White Blood Cell'];
        const missingCriticalData = [];

        scoreComponentData.forEach(item => {
            const paramName = item.parameter || '';
            requiredParameters.forEach(required => {
                if (paramName.includes(required)) {
                    const inputElement = document.getElementById(`input-${item.parameter}`);
                    if (inputElement && inputElement.type === 'number') {
                        // Check if the input is empty or has no valid value
                        const isEmpty = !inputElement.value || inputElement.value.trim() === '';
                        if (isEmpty) {
                            missingCriticalData.push(required);
                        }
                    }
                }
            });
        });

        // If critical data is missing, show warning in the Total Risk Score area
        if (missingCriticalData.length > 0) {
            // Show warning message instead of risk score
            document.getElementById('total-score').innerHTML = `
                <i class="fas fa-exclamation-triangle text-warning"></i>
            `;
            document.getElementById('risk-level').innerHTML = `
                <span class="text-warning">Incomplete Data</span>
            `;
            document.getElementById('recommendation').innerHTML = `
                <div class="alert alert-warning mb-0" role="alert">
                    <strong><i class="fas fa-edit"></i> Please enter the following missing data:</strong>
                    <ul class="mb-0 mt-2">
                        ${missingCriticalData.map(param => {
                let displayName = param;
                if (param === 'Age') displayName = 'Age';
                if (param === 'Hemoglobin') displayName = 'Hemoglobin';
                if (param === 'eGFR') displayName = 'eGFR (Glomerular Filtration Rate)';
                if (param === 'White Blood Cell') displayName = 'White Blood Cell Count';
                return `<li><strong>${displayName}</strong></li>`;
            }).join('')}
                    </ul>
                    <p class="mb-0 mt-2"><small>Once complete data is entered, the risk score will be calculated automatically.</small></p>
                </div>
            `;

            // Hide CCD export button when data is incomplete
            document.getElementById('exportCcdBtn').classList.add('d-none');

            return; // Stop calculation but keep UI visible
        }

        // === NEW: Check for validation errors that should block calculation ===
        const validationErrors = hasValidationErrors();
        if (validationErrors.length > 0) {
            // Show validation error message instead of risk score
            document.getElementById('total-score').innerHTML = `
                <i class="fas fa-times-circle text-danger"></i>
            `;
            document.getElementById('risk-level').innerHTML = `
                <span class="text-danger">Invalid Values</span>
            `;
            document.getElementById('recommendation').innerHTML = `
                <div class="alert alert-danger mb-0" role="alert">
                    <strong><i class="fas fa-exclamation-circle"></i> Cannot calculate risk score - Please correct the following errors:</strong>
                    <ul class="mb-0 mt-2">
                        ${validationErrors.map(err => {
                const cleanParam = err.parameter.replace('PRECISE-HBR - ', '');
                return `<li><strong>${cleanParam}:</strong> ${err.message}</li>`;
            }).join('')}
                    </ul>
                    <p class="mb-0 mt-2"><small>Please enter clinically valid values to calculate the risk score.</small></p>
                </div>
            `;

            // Hide CCD export button when there are validation errors
            document.getElementById('exportCcdBtn').classList.add('d-none');

            return; // Stop calculation
        }

        // If we get here, all critical data is present and valid
        // Show CCD export button
        document.getElementById('exportCcdBtn').classList.remove('d-none');

        let totalScoreRaw = 0;

        // Find the base score from the original data and add it.
        const baseScoreItem = scoreComponentData.find(c => c.parameter.includes("Base Score"));
        totalScoreRaw += baseScoreItem ? baseScoreItem.score : 2;

        // Track ARC-HBR elements state for calculating the summary score
        let arcHbrElementsChecked = 0;

        scoreComponentData.forEach(item => {
            if (item.parameter.includes("Base Score")) return; // Skip base score, already added
            if (item.parameter.includes("ARC-HBR Summary")) return; // Skip summary, will calculate later

            let currentScore = 0;
            let currentScoreRaw = 0;
            const inputElement = document.getElementById(`input-${item.parameter}`);
            if (!inputElement) return;

            if (inputElement.type === 'number') {
                // Check if this was originally missing data
                const isMissingData = inputElement.getAttribute('data-missing') === 'true';

                // Only calculate if we have a value (not empty)
                if (inputElement.value && inputElement.value.trim() !== '') {
                    const value = parseFloat(inputElement.value);

                    // Replicate backend calculation logic
                    if (item.parameter.includes("Age")) {
                        const effective = Math.max(30, Math.min(80, value));
                        if (effective > 30) currentScoreRaw = (effective - 30) * 0.25;
                    } else if (item.parameter.includes("Hemoglobin")) {
                        // Convert to g/dL if needed for calculation
                        let hbValue = value;
                        if (unitSettings.hemoglobin === 'mmol/L') {
                            hbValue = convertHemoglobin(value, 'mmol/L', 'g/dL');
                        }
                        const effective = Math.max(5.0, Math.min(15.0, hbValue));
                        if (effective < 15) currentScoreRaw = (15 - effective) * 2.5;
                    } else if (item.parameter.includes("eGFR")) {
                        const effective = Math.max(5, Math.min(100, value));
                        if (effective < 100) currentScoreRaw = (100 - effective) * 0.05;
                    } else if (item.parameter.includes("White Blood Cell")) {
                        const effective = Math.min(15.0, value);
                        if (effective > 3.0) currentScoreRaw = (effective - 3.0) * 0.8;
                    }

                    // If user manually entered data, update styling to show it's no longer missing
                    if (isMissingData) {
                        inputElement.classList.remove('input-missing');
                        inputElement.classList.add('form-control'); // Re-add default form-control styling

                        const inputGroup = inputElement.closest('.input-group');
                        if (inputGroup) {
                            const unitSpans = inputGroup.querySelectorAll('.input-group-text');
                            unitSpans.forEach(span => {
                                span.classList.remove('unit-missing', 'icon-missing');
                                span.classList.add('input-unit-lg'); // Re-add default unit styling
                            });
                        }
                        inputElement.removeAttribute('data-missing'); // Mark as no longer missing
                    }
                }
                // Note: If input is empty, we already checked for critical data at the start
                // Non-critical empty fields (Previous bleeding, OAC) will simply contribute 0 score
            } else if (inputElement.type === 'checkbox') {
                const isChecked = inputElement.checked;
                const label = document.querySelector(`label[for='${inputElement.id}']`);
                const isArcElement = inputElement.getAttribute('data-is-arc-element') === 'true';

                if (isChecked) {
                    if (item.parameter.includes("Prior Bleeding")) currentScoreRaw = 7;
                    if (item.parameter.includes("Oral Anticoagulation")) currentScoreRaw = 5;
                    // Individual ARC-HBR elements don't add score directly
                    if (isArcElement) {
                        arcHbrElementsChecked++;
                    }
                    if (label) label.textContent = "Yes";
                } else {
                    if (label) label.textContent = "No";
                }
            }

            totalScoreRaw += currentScoreRaw;
            currentScore = Math.round(currentScoreRaw);

            // Update individual score badge (but not for ARC-HBR elements)
            const scoreBadge = document.getElementById(`score-${item.parameter}`);
            if (scoreBadge && !item.is_arc_hbr_element) {
                scoreBadge.textContent = currentScore;
                scoreBadge.className = `badge ${currentScore > 0 ? 'bg-danger' : 'bg-secondary'} score-badge`;
            }
        });

        // Calculate ARC-HBR Summary score (3 points if any element is checked)
        const arcHbrSummaryScore = arcHbrElementsChecked > 0 ? 3 : 0;
        totalScoreRaw += arcHbrSummaryScore;

        // Update ARC-HBR Summary badge
        const arcHbrSummaryItem = scoreComponentData.find(c => c.parameter.includes("ARC-HBR Summary"));
        if (arcHbrSummaryItem) {
            const arcSummaryBadge = document.getElementById(`score-${arcHbrSummaryItem.parameter}`);
            if (arcSummaryBadge) {
                arcSummaryBadge.textContent = arcHbrSummaryScore;
                arcSummaryBadge.className = `badge ${arcHbrSummaryScore > 0 ? 'bg-danger' : 'bg-secondary'} score-badge`;
            }
        }

        const finalScore = Math.round(totalScoreRaw);

        // Check if any component is outdated (check original scoreComponentData for is_outdated flag)
        // AND use the check if the value hasn't been manually overruled (though currently we don't track overruled easily, 
        // so we stick to the safe assumption: if source was outdated, warn the user).
        let hasOutdatedData = false;
        if (scoreComponentData) {
            hasOutdatedData = scoreComponentData.some(item => item.is_outdated === true);
        }

        updateTotalScoreUI(finalScore, hasOutdatedData);

        // Update missing data warning after recalculation
        updateMissingDataWarning();
    }

    function updateMissingDataWarning() {
        // Check for any remaining missing data (empty input fields with data-missing="true")
        const missingInputs = document.querySelectorAll('input[data-missing="true"]');
        const remainingMissingItems = [];

        missingInputs.forEach(input => {
            if (!input.value || input.value.trim() === '') {
                // Find the corresponding parameter name
                const row = input.closest('tr');
                if (row) {
                    const parameterCell = row.querySelector('td:first-child');
                    if (parameterCell) {
                        remainingMissingItems.push(parameterCell.textContent.trim());
                    }
                }
            }
        });

        // Update the warning display
        displayMissingDataWarning(remainingMissingItems);
    }

    function updateTotalScoreUI(score, hasOutdatedData = false) {
        const totalScoreEl = document.getElementById('total-score');
        const riskLevelEl = document.getElementById('risk-level');

        let riskCategory = "";
        let colorClass = "";
        let scoreColor = "";
        let recommendation = "";
        let riskPercent = 0;

        // Determine risk level and colors
        // Replicate bleeding risk percentage and category logic from backend
        if (score <= 22) {
            riskPercent = 0.5 + (score / 22) * 3.0;
            riskCategory = `Not high bleeding risk (score ≤22)`;
            colorClass = 'text-success';
            scoreColor = '#28a745'; // green
        } else if (score <= 26) {
            riskPercent = 3.5 + ((score - 22) / 4) * 2.0;
            riskCategory = `HBR (score 23-26)`;
            colorClass = 'text-warning';
            scoreColor = '#fd7e14'; // orange
        } else { // score >= 27
            riskPercent = 5.5 + ((score - 26) / 4) * 2.5;
            if (score > 30) riskPercent = 8.0 + ((score - 30) / 5) * 4.0;
            if (score > 35) riskPercent = 12.0 + ((score - 35) / 10) * 3.0;
            riskCategory = `Very HBR (score ≥27)`;
            colorClass = 'text-danger';
            scoreColor = '#dc3545'; // red
        }
        riskPercent = Math.min(15.0, riskPercent);
        recommendation = `1-year risk of major bleeding: ${riskPercent.toFixed(2)}% (Bleeding Academic Research Consortium [BARC] type 3 or 5)`;

        // Apply color and bold to total score
        totalScoreEl.textContent = score;
        totalScoreEl.style.color = scoreColor; // Color is dynamic, hard to move to class without many classes
        totalScoreEl.className = 'display-3 font-weight-900';

        riskLevelEl.textContent = riskCategory;
        riskLevelEl.className = `h4 ${colorClass}`;
        document.getElementById('recommendation').textContent = recommendation;

        // Update currentPatientData with latest score and risk level
        if (currentPatientData) {
            currentPatientData.total_score = score;
            currentPatientData.risk_level = riskCategory;
            currentPatientData.recommendation = recommendation;
        }

        // --- NEW: Add/Remove Tradeoff Analysis Link ---
        const totalScoreCard = document.getElementById('risk-level').parentElement;
        // First, remove any existing tradeoff link to prevent duplicates
        const existingLink = totalScoreCard.querySelector('#tradeoff-link-container');
        if (existingLink) {
            existingLink.remove();
        }

        // Add the link only if the score is 23 or higher (HBR threshold)
        if (score >= 23) {
            const tradeoffDiv = document.createElement('div');
            tradeoffDiv.id = 'tradeoff-link-container'; // Add an ID for easy removal
            tradeoffDiv.className = 'alert alert-info mt-3';
            tradeoffDiv.innerHTML = `
                <strong>High Bleeding Risk Detected (PRECISE-HBR ≥23).</strong>
                <br><br>
                <a href="/tradeoff_analysis" class="btn btn-info btn-sm mt-2">
                    <i class="fas fa-chart-line"></i> View Bleeding vs. Thrombosis Trade-off Analysis
                </a>`;
            totalScoreCard.appendChild(tradeoffDiv);
        }

        // --- NEW: Show/Hide HBR Recommendations Section ---
        const hbrRecommendationsSection = document.getElementById('hbr-recommendations-section');
        if (score >= 23) {
            // Show HBR recommendations with smooth animation
            hbrRecommendationsSection.classList.remove('d-none');
            // Smooth scroll to recommendations after a brief delay
            setTimeout(() => {
                hbrRecommendationsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 500);
        } else {
            // Hide HBR recommendations if score drops below threshold
            hbrRecommendationsSection.classList.add('d-none');
        }

        // --- NEW: Outdated Data Warning ---
        // Add warning about outdated data
        const outdatedWarningId = 'outdated-data-warning';
        const existingOutdated = totalScoreCard.querySelector(`#${outdatedWarningId}`);
        if (existingOutdated) existingOutdated.remove();

        if (hasOutdatedData) {
            const outdatedDiv = document.createElement('div');
            outdatedDiv.id = outdatedWarningId;
            outdatedDiv.className = 'alert alert-danger mt-3 mb-0';
            outdatedDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Data Outdated (>3 months):</strong> Risk score may be unreliable. Please re-verify values.
            `;
            totalScoreCard.appendChild(outdatedDiv);
        }
    }

    function displayError(errorMessage) {
        document.getElementById('loading-container').classList.add('d-none');
        document.getElementById('error-container').classList.remove('d-none');
        document.getElementById('error-message').textContent = errorMessage;
    }

    function translateParameterName(parameterName) {
        // Clean up parameter names for better display
        const translations = {
            'PRECISE-HBR - Base Score': 'Base Score (fixed)',
            'PRECISE-HBR - Age': 'Age (truncated 30-80 years)',
            'PRECISE-HBR - Hemoglobin': 'Hemoglobin (truncated 5-15 g/dL)',
            'PRECISE-HBR - eGFR': 'eGFR (truncated above 100)',
            'PRECISE-HBR - White Blood Cell Count': 'White Blood Cell Count (truncated above 15×10³)',
            'PRECISE-HBR - Prior Bleeding': 'Previous bleeding',
            'PRECISE-HBR - Oral Anticoagulation': 'Long-term oral anticoagulation',
            'PRECISE-HBR - Platelet Count': 'Platelet count <100 ×10⁹/L',
            'PRECISE-HBR - Chronic Bleeding Diathesis': 'Chronic bleeding diathesis',
            'PRECISE-HBR - Liver Cirrhosis': 'Liver cirrhosis with portal hypertension',
            'PRECISE-HBR - Active Malignancy': 'Active malignancy',
            'PRECISE-HBR - NSAIDs/Corticosteroids': 'Chronic use of nsaids or corticosteroids',
            'PRECISE-HBR - ARC-HBR Summary': 'ARC-HBR Elements ≥1'
        };

        return translations[parameterName] || parameterName;
    }

    // Feedback System Functions
    function submitFeedback(feedbackType) {
        currentFeedbackType = feedbackType;

        // Show comment section for additional feedback
        document.getElementById('commentSection').classList.remove('d-none');

        // Update button states
        document.getElementById('thumbsUpBtn').disabled = true;
        document.getElementById('thumbsDownBtn').disabled = true;

        // Highlight selected button
        if (feedbackType === 'thumbs_up') {
            document.getElementById('thumbsUpBtn').classList.remove('btn-outline-success');
            document.getElementById('thumbsUpBtn').classList.add('btn-success');
        } else {
            document.getElementById('thumbsDownBtn').classList.remove('btn-outline-danger');
            document.getElementById('thumbsDownBtn').classList.add('btn-danger');
        }
    }

    function submitComment() {
        if (!currentPatientData) {
            console.error('No patient data available for feedback');
            return;
        }

        const comment = document.getElementById('feedbackComment').value;

        // Get patient ID from various sources
        const patientId = currentPatientData.patient_info?.patient_id ||
            currentPatientData.patient_info?.id ||
            sessionStorage.getItem('current_patient_id') ||
            'unknown';

        // Prepare feedback data
        const feedbackData = {
            patient_id: patientId,
            feedback_type: currentFeedbackType,
            comment: comment,
            score: currentPatientData.total_score,
            risk_level: currentPatientData.risk_level
        };

        // Show loading state
        document.getElementById('submitCommentBtn').disabled = true;
        document.getElementById('submitCommentBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Submitting...';

        // Submit feedback via AJAX
        // const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch('/api/feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // 'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(feedbackData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Show success message
                    document.getElementById('feedbackMessage').textContent = data.message;
                    document.getElementById('feedbackSuccess').classList.remove('d-none');
                    document.getElementById('feedbackError').classList.add('d-none');

                    // Hide comment section and buttons
                    document.getElementById('commentSection').classList.add('d-none');
                    document.getElementById('thumbsUpBtn').classList.add('d-none');
                    document.getElementById('thumbsDownBtn').classList.add('d-none');

                    // Show a thank you message
                    setTimeout(() => {
                        document.getElementById('feedbackSection').innerHTML = `
                        <div class="text-center py-3 feedback-thank-you">
                            <i class="fas fa-heart text-danger fa-2x mb-2"></i>
                            <h5 class="text-success">Thank you for your valuable feedback!</h5>
                            <p class="text-muted mb-0">Your feedback helps us improve the accuracy of our calculations.</p>
                        </div>
                    `;
                    }, 2000);
                } else {
                    // Show error message
                    document.getElementById('feedbackError').classList.remove('d-none');
                    document.getElementById('feedbackSuccess').classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('Error submitting feedback:', error);
                document.getElementById('feedbackError').classList.remove('d-none');
                document.getElementById('feedbackSuccess').classList.add('d-none');
            })
            .finally(() => {
                // Reset button state
                document.getElementById('submitCommentBtn').disabled = false;
                document.getElementById('submitCommentBtn').innerHTML = '<i class="fas fa-paper-plane mr-1"></i>Submit Feedback';
            });
    }

    function cancelFeedback() {
        // Hide comment section
        document.getElementById('commentSection').classList.add('d-none');

        // Reset button states
        document.getElementById('thumbsUpBtn').disabled = false;
        document.getElementById('thumbsDownBtn').disabled = false;

        // Reset button classes
        document.getElementById('thumbsUpBtn').classList.remove('btn-success');
        document.getElementById('thumbsUpBtn').classList.add('btn-outline-success');
        document.getElementById('thumbsDownBtn').classList.remove('btn-danger');
        document.getElementById('thumbsDownBtn').classList.add('btn-outline-danger');

        // Clear comment
        document.getElementById('feedbackComment').value = '';

        // Reset feedback type
        currentFeedbackType = null;
    }

    // ==========================================================================
    // ONC COMPLIANCE: 45 CFR 170.315 (b)(6) - Data Export (CCD)
    // Export risk assessment results as C-CDA Continuity of Care Document
    // ==========================================================================

    function exportCCD() {
        if (!currentPatientData) {
            alert('No patient data available for export. Please calculate risk first.');
            return;
        }

        // Check if required risk data exists
        if (!currentPatientData.total_score || !currentPatientData.risk_level) {
            alert('Risk score is incomplete. Please ensure all required data (Age, Hemoglobin, eGFR, WBC) is filled in.');
            return;
        }

        // Show loading state on button
        const exportBtn = document.getElementById('exportCcdBtn');
        const originalHtml = exportBtn.innerHTML;
        exportBtn.disabled = true;
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

        // Prepare data for CCD export
        const exportData = {
            patient_name: currentPatientData.patient_info.name || 'Unknown Patient',
            patient_gender: currentPatientData.patient_info.gender || 'Unknown',
            patient_birth_date: calculateBirthDate(currentPatientData.patient_info.age),
            patient_age: currentPatientData.patient_info.age || 'Unknown',
            risk_data: {
                total_score: currentPatientData.total_score,
                risk_category: currentPatientData.risk_level,
                bleeding_risk_percent: extractBleedingRiskPercent(currentPatientData.recommendation),
                egfr: getParameterValue('eGFR'),
                hemoglobin: getParameterValue('Hemoglobin'),
                wbc: getParameterValue('White Blood Cell'),
                platelets: getParameterValue('Platelets'),
                arc_hbr_factors: getARCHBRFactors()
            }
        };

        // Debug: Log the export data in detail
        console.log('=== CCD Export Debug ===');
        console.log('Full Export Data:', exportData);
        console.log('Risk Data:', exportData.risk_data);
        console.log('Total Score:', exportData.risk_data.total_score);
        console.log('Risk Category:', exportData.risk_data.risk_category);
        console.log('currentPatientData:', currentPatientData);

        // Send POST request to export API
        // const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch('/api/export-ccd', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // 'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(exportData)
        })
            .then(async response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                const contentType = response.headers.get('content-type');
                console.log('Content-Type:', contentType);

                if (!response.ok) {
                    // Try to get error details from response
                    let errorMessage = `Server error: ${response.status} ${response.statusText}`;

                    // Clone the response so we can try multiple parsing methods
                    const responseClone = response.clone();

                    try {
                        // Check if response is JSON
                        if (contentType && contentType.includes('application/json')) {
                            const errorData = await response.json();
                            console.error('Server error details:', errorData);
                            console.error('Error message:', errorData.error);
                            console.error('Error details:', errorData.details);
                            console.error('Received fields:', errorData.received_fields);
                            console.error('Missing fields:', errorData.missing_fields);

                            errorMessage = errorData.error || errorData.details || errorMessage;
                            if (errorData.missing_fields && errorData.missing_fields.length > 0) {
                                errorMessage += `\nMissing fields: ${errorData.missing_fields.join(', ')}`;
                            }
                        } else {
                            // Response is HTML or text
                            const textResponse = await responseClone.text();
                            console.error('Response text (first 500 chars):', textResponse.substring(0, 500));

                            // Try to extract error message from HTML
                            const errorMatch = textResponse.match(/<title>(.*?)<\/title>/i);
                            if (errorMatch) {
                                errorMessage = errorMatch[1];
                            }
                        }
                    } catch (parseError) {
                        console.error('Failed to parse error response:', parseError);
                    }

                    throw new Error(errorMessage);
                }
                return response.blob();
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `PRECISE_HBR_CCD_${currentPatientData.patient_info.patient_id || 'patient'}_${new Date().toISOString().split('T')[0]}.xml`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // Show success message
                alert('CCD document exported successfully!');
            })
            .catch(error => {
                console.error('Error exporting CCD:', error);
                alert(`Failed to export CCD document:\n\n${error.message}\n\nPlease check the browser console for more details.`);
            })
            .finally(() => {
                // Restore button state
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalHtml;
            });
    }

    // Helper function to calculate approximate birth date from age
    function calculateBirthDate(age) {
        if (!age || age === 'N/A') {
            return '1970-01-01';
        }
        const currentYear = new Date().getFullYear();
        const birthYear = currentYear - parseInt(age);
        return `${birthYear}-01-01`;
    }

    // Helper function to extract bleeding risk percentage from recommendation text
    function extractBleedingRiskPercent(recommendation) {
        if (!recommendation) return 'N/A';
        const match = recommendation.match(/(\d+\.?\d*)%/);
        return match ? match[1] : 'N/A';
    }

    // Helper function to get parameter value from current data
    function getParameterValue(parameterName) {
        if (!currentPatientData || !currentPatientData.score_components) {
            return 'Not available';
        }

        const component = currentPatientData.score_components.find(c =>
            c.parameter.includes(parameterName)
        );

        if (!component) {
            return 'Not available';
        }

        // For CCD export, return only the numeric raw_value (CCD generator adds units)
        if (component.raw_value !== null && component.raw_value !== undefined) {
            return component.raw_value;
        }

        // For boolean values, return the is_present status
        if (component.is_present !== null && component.is_present !== undefined) {
            return component.is_present ? 'Present' : 'Absent';
        }

        return component.value || 'Not available';
    }

    // Helper function to extract ARC-HBR factors
    function getARCHBRFactors() {
        const factors = [];

        if (!currentPatientData || !currentPatientData.score_components) {
            return factors;
        }

        // Check for prior bleeding
        const priorBleeding = currentPatientData.score_components.find(c =>
            c.parameter.includes('Prior Bleeding')
        );
        if (priorBleeding && priorBleeding.value === true) {
            factors.push('Prior spontaneous bleeding requiring hospitalization or transfusion');
        }

        // Check for oral anticoagulation
        const oralAnticoag = currentPatientData.score_components.find(c =>
            c.parameter.includes('Oral Anticoagulation')
        );
        if (oralAnticoag && oralAnticoag.value === true) {
            factors.push('Long-term oral anticoagulation therapy');
        }

        // Check for other ARC-HBR factors
        const arcHBR = currentPatientData.score_components.find(c =>
            c.parameter.includes('ARC-HBR')
        );
        if (arcHBR && arcHBR.value === true) {
            factors.push('One or more ARC-HBR major or minor criteria');
        }

        return factors;
    }

    // ==========================================================================
    // ONC COMPLIANCE: 45 CFR 170.315 (d)(5) - Automatic Access Time-out
    // Automatically stop user access after predetermined period of inactivity
    // ==========================================================================

    (function () {
        // Configuration
        const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5 minutes in milliseconds
        const WARNING_BEFORE_TIMEOUT = 60 * 1000;  // Show warning 1 minute before timeout

        let inactivityTimer = null;
        let warningTimer = null;
        let warningModal = null;

        // Events that indicate user activity
        const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];

        function resetInactivityTimer() {
            // Clear existing timers
            if (inactivityTimer) clearTimeout(inactivityTimer);
            if (warningTimer) clearTimeout(warningTimer);
            if (warningModal) closeWarningModal();

            // Set warning timer (fires 1 minute before actual timeout)
            warningTimer = setTimeout(showTimeoutWarning, INACTIVITY_TIMEOUT - WARNING_BEFORE_TIMEOUT);

            // Set actual timeout timer
            inactivityTimer = setTimeout(performLogout, INACTIVITY_TIMEOUT);
        }

        function showTimeoutWarning() {
            // Create modal if it doesn't exist
            if (!warningModal) {
                warningModal = document.createElement('div');
                warningModal.className = 'modal fade show';
                warningModal.style.display = 'block';
                warningModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                warningModal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title">
                                    <i class="fas fa-exclamation-triangle"></i> Session Timeout Warning
                                </h5>
                            </div>
                            <div class="modal-body">
                                <p><strong>Your session will expire in 1 minute due to inactivity.</strong></p>
                                <p>For security purposes, access to patient information is automatically stopped after 5 minutes of inactivity.</p>
                                <p>Click "Stay Logged In" to continue working, or you will be automatically logged out.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" id="stay-logged-in-btn">
                                    <i class="fas fa-check"></i> Stay Logged In
                                </button>
                                <button type="button" class="btn btn-secondary" id="logout-now-btn">
                                    <i class="fas fa-sign-out-alt"></i> Logout Now
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(warningModal);

                // Attach event handlers
                document.getElementById('stay-logged-in-btn').addEventListener('click', function () {
                    closeWarningModal();
                    resetInactivityTimer(); // Reset the timer as if user was active
                });

                document.getElementById('logout-now-btn').addEventListener('click', function () {
                    performLogout();
                });
            } else {
                warningModal.style.display = 'block';
            }
        }

        function closeWarningModal() {
            if (warningModal) {
                warningModal.style.display = 'none';
            }
        }

        function performLogout() {
            // Clear all timers
            if (inactivityTimer) clearTimeout(inactivityTimer);
            if (warningTimer) clearTimeout(warningTimer);

            // Remove event listeners to prevent further activity tracking
            activityEvents.forEach(function (eventName) {
                document.removeEventListener(eventName, resetInactivityTimer, true);
            });

            // Display logout message
            const body = document.body;
            body.innerHTML = `
                <div class="container mt-5">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h4><i class="fas fa-clock"></i> Session Expired</h4>
                                </div>
                                <div class="card-body text-center">
                                    <p class="lead">Your session has been automatically ended due to inactivity.</p>
                                    <p>This is a security measure to protect patient information.</p>
                                    <hr>
                                    <p class="text-muted">
                                        <small>
                                            <i class="fas fa-shield-alt"></i> 
                                            Compliant with ONC 45 CFR 170.315 (d)(5) - Automatic Access Time-out (5 minutes)
                                        </small>
                                    </p>
                                    <a href="/" class="btn btn-primary mt-3">
                                        <i class="fas fa-redo"></i> Return to Login
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Optionally, make a backend call to invalidate the session
            fetch('/logout', {
                method: 'POST',
                credentials: 'same-origin'
            }).catch(function (err) {
                console.error('Logout request failed:', err);
            });
        }

        // Attach activity listeners
        activityEvents.forEach(function (eventName) {
            document.addEventListener(eventName, resetInactivityTimer, true);
        });

        // Start the timer on page load
        resetInactivityTimer();

        console.log('ONC Compliance: Automatic session timeout enabled (5 minutes inactivity)');
    })();
</script>

<!-- Custom CSS for Feedback Styling -->
<style>
    /* Global Font Setting - Apply to body and common elements */
    body,
    html {
        font-family: Arial, sans-serif;
    }

    /* Apply Arial to text elements */
    p,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    span,
    div,
    td,
    th,
    label,
    button,
    input,
    select,
    textarea,
    a {
        font-family: Arial, sans-serif;
    }

    /* Preserve Font Awesome icons - CRITICAL for icon display */
    .fas,
    .far,
    .fab,
    .fa,
    .fal,
    .fad,
    [class^="fa-"],
    [class*=" fa-"] {
        font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands", "Font Awesome 5 Free" !important;
        font-weight: 900;
    }

    .far {
        font-weight: 400 !important;
    }

    .fab {
        font-family: "Font Awesome 6 Brands" !important;
    }

    /* === NEW: Responsive Design === */
    @media (max-width: 768px) {

        body,
        p,
        td,
        th,
        label,
        button,
        input,
        select,
        textarea {
            font-size: 14px !important;
        }

        h1 {
            font-size: 1.75rem !important;
        }

        h2 {
            font-size: 1.5rem !important;
        }

        h3 {
            font-size: 1.25rem !important;
        }

        h4 {
            font-size: 1.1rem !important;
        }

        .display-3 {
            font-size: 3rem !important;
        }

        .card {
            padding: 15px !important;
        }

        .btn {
            padding: 10px 15px !important;
            font-size: 14px !important;
        }
    }

    @media (max-width: 480px) {

        body,
        p,
        td,
        th,
        label,
        button,
        input,
        select,
        textarea {
            font-size: 12px !important;
        }

        h1 {
            font-size: 1.5rem !important;
        }

        h2 {
            font-size: 1.25rem !important;
        }

        .display-3 {
            font-size: 2.5rem !important;
        }

        .card {
            padding: 10px !important;
        }
    }

    /* === NEW: Unit Conversion Button Styling === */
    .unit-toggle-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        cursor: pointer;
        margin-left: 5px;
        transition: background 0.2s;
    }

    .unit-toggle-btn:hover {
        background: #5a6268;
    }

    /* === NEW: Value Warning Styling === */
    .value-warning {
        border-color: #ffc107 !important;
        background-color: #fff3cd !important;
    }

    .value-error {
        border-color: #dc3545 !important;
        background-color: #f8d7da !important;
    }

    .value-normal {
        border-color: #28a745 !important;
    }

    /* === NEW: Tooltip Styling === */
    .info-tooltip {
        position: relative;
        display: inline-block;
        margin-left: 5px;
        cursor: help;
        color: #6c757d;
    }

    .info-tooltip:hover {
        color: #007bff;
    }

    .tooltip-content {
        visibility: hidden;
        width: 300px;
        background-color: #2d3748;
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 12px;
        position: absolute;
        z-index: 1000;
        bottom: 125%;
        left: 50%;
        margin-left: -150px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.9rem;
        line-height: 1.4;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .tooltip-content::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #2d3748 transparent transparent transparent;
    }

    .info-tooltip:hover .tooltip-content {
        visibility: visible;
        opacity: 1;
    }

    @media (max-width: 768px) {
        .tooltip-content {
            width: 250px;
            margin-left: -125px;
        }
    }

    /* Feedback Section Styling */
    .card-header.bg-light {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
        border-bottom: 2px solid #dee2e6;
    }

    #thumbsUpBtn:hover,
    #thumbsDownBtn:hover {
        transform: scale(1.05);
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    #thumbsUpBtn.btn-success {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        border-color: #1c7430;
        animation: successPulse 0.6s ease-in-out;
    }

    #thumbsDownBtn.btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        border-color: #bd2130;
        animation: dangerPulse 0.6s ease-in-out;
    }

    @keyframes successPulse {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.1);
        }

        100% {
            transform: scale(1);
        }
    }

    @keyframes dangerPulse {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.1);
        }

        100% {
            transform: scale(1);
        }
    }

    .feedback-thank-you {
        animation: fadeInUp 0.5s ease-in-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* === HBR Recommendations Section Styling === */
    #hbr-recommendations-section {
        animation: fadeInUp 0.6s ease-in-out;
        font-family: Arial, sans-serif;
    }

    #hbr-recommendations-section h4,
    #hbr-recommendations-section h5,
    #hbr-recommendations-section h6 {
        font-family: Arial, sans-serif;
    }

    #hbr-recommendations-section .alert,
    #hbr-recommendations-section .card-body {
        font-family: Arial, sans-serif;
        font-size: 1rem;
        line-height: 1.6;
    }

    #hbr-recommendations-section ul li {
        margin-bottom: 0.5rem;
        font-size: 1rem;
    }

    #hbr-recommendations-section .card-header h5 {
        font-size: 1.15rem;
    }

    #hbr-recommendations-section img {
        transition: transform 0.3s ease;
        max-height: 600px;
        object-fit: contain;
    }

    #hbr-recommendations-section img:hover {
        transform: scale(1.02);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }

    /* Responsive adjustments for HBR section */
    @media (max-width: 768px) {
        #hbr-recommendations-section h4 {
            font-size: 1.25rem;
        }

        #hbr-recommendations-section ul li {
            font-size: 0.95rem;
        }

        #hbr-recommendations-section img {
            max-height: 400px;
        }
    }
</style>
{% endblock %}