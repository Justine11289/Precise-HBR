<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Bleeding vs. Thrombosis Trade-off Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .chart-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
        }

        .factor-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            text-align: center;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .content-hidden {
            opacity: 0.3;
            pointer-events: none;
        }

        /* Image card styling */
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .card img {
            transition: transform 0.3s;
            cursor: pointer;
        }

        .card img:hover {
            transform: scale(1.05);
        }

        /* Responsive images */
        @media (max-width: 768px) {
            .card img {
                max-height: 250px !important;
            }
        }

        /* Citation button styling */
        .btn-success {
            transition: all 0.3s;
        }

        .btn-success:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(25, 135, 84, 0.4);
        }

        /* Alert styling */
        .alert-secondary {
            background-color: #f8f9fa;
            border-left: 4px solid #6c757d;
        }

        .alert-info {
            background-color: #e7f3ff;
            border-left: 4px solid #0dcaf0;
        }

        /* Factor list item styling */
        .list-group-item {
            font-family: Arial, sans-serif;
            font-size: 1.1rem;
            padding: 1rem 1.25rem;
        }

        .list-group-item:hover {
            background-color: #f8f9fa;
        }

        /* Factor checkbox styling */
        .form-check-input {
            width: 1.5em;
            height: 1.5em;
            margin-top: 0.1em;
        }

        .form-check-input:checked {
            background-color: #198754;
            border-color: #198754;
        }

        /* Badge alignment and sizing */
        .badge {
            font-family: Arial, sans-serif;
            font-size: 0.85rem;
            padding: 0.35em 0.65em;
            font-weight: 600;
        }

        /* Better spacing for factor labels */
        .form-check-label {
            cursor: pointer;
            padding-left: 0.5rem;
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }

        /* HR info text */
        .form-check-label small {
            font-size: 0.95rem;
            font-family: Arial, sans-serif;
        }

        /* Legend box at bottom of factors */
        .alert-light {
            font-family: Arial, sans-serif;
            font-size: 1rem;
        }

        /* Recommendations section styling */
        #recommendations-section {
            font-family: Arial, sans-serif;
        }

        #recommendations-section h4,
        #recommendations-section h5,
        #recommendations-section h6 {
            font-family: Arial, sans-serif;
        }

        #recommendations-section .alert,
        #recommendations-section .card-body {
            font-family: Arial, sans-serif;
            font-size: 1rem;
            line-height: 1.6;
        }

        #recommendations-section ul li {
            margin-bottom: 0.5rem;
        }

        #recommendations-section .card-header h5 {
            font-size: 1.15rem;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
            <div class="mt-3">
                <h5>Loading Trade-off Analysis...</h5>
                <p class="text-muted">Please wait...</p>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4" id="main-content">
        <h3 class="text-center">Risk Trade-off Analysis (Bleeding vs. Ischemic Risk)</h3>
        <p class="text-center text-muted">Patient ID: {{ patient_id }}</p>

        <div class="row justify-content-center" id="content-row" style="visibility: visible;">
            <div class="col-md-4" id="chart-column">
                <div class="chart-container">
                    <canvas id="tradeoffChart"></canvas>
                </div>
                <div id="chart-legend" class="mt-3">
                    <p><span style="color: #87CEEB;">‚ñ†</span> <strong>Teal Area:</strong> Above equal trade-off line
                        (y=x).
                        Ischemic risk is higher than bleeding risk.</p>
                    <p><span style="color: #C8C8C8;">‚ñ†</span> <strong>Gray Area:</strong> Between equal (1:1) and
                        mortality-weighted lines.
                        Considering that MI/ST has 1.9√ó higher associated mortality, risks can be considered equivalent.
                    </p>
                    <p><span style="color: #FFC896;">‚ñ†</span> <strong>Orange Area:</strong> Below mortality-weighted
                        line (y=x/1.9).
                        Bleeding risk dominates when considering associated mortality.</p>
                    <hr>
                    <small class="text-muted">
                        <strong>Lines:</strong><br>
                        <span style="color: #006464;">---</span> Equal trade-off (1:1)<br>
                        <span style="color: #FF8C00;">---</span> Mortality-weighted trade-off (1:1.9)
                    </small>
                </div>
            </div>
            <div class="col-md-5" id="risk-factors-column">
                <div class="card">
                    <div class="card-header bg-gradient"
                        style="background: linear-gradient(90deg, #dc3545 0%, #0d6efd 100%); color: white;">
                        <h5 class="mb-0">Risk Factors</h5>
                        <small>Select applicable factors - they will be applied to relevant risk calculations</small>
                    </div>
                    <ul class="list-group list-group-flush factor-list" id="all-factors" style="max-height: 500px;">
                    </ul>
                </div>
                <div class="mt-3">
                    <div class="alert alert-light border">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-danger me-2">Bleeding</span>
                            <small>Affects bleeding risk only</small>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-primary me-2">Thrombotic</span>
                            <small>Affects thrombotic risk only</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-danger me-1">Bleeding</span>
                            <span class="badge bg-primary me-2">Thrombotic</span>
                            <small>Affects both risks</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clinical Recommendations Section -->
        <div class="row mt-5" id="recommendations-section" style="display: none;">
            <div class="col-12">
                <hr class="my-4">
                <div class="alert alert-warning border-warning" style="border-left: 5px solid #ffc107;">
                    <h4 class="mb-3">
                        <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                        <strong>High Bleeding Risk (HBR) Detected</strong>
                    </h4>
                    <p class="mb-3">
                        Based on the ARC-HBR criteria, this patient has been identified as having <strong>high bleeding
                            risk</strong>.
                        Consider the following antiplatelet strategies to reduce bleeding risk:
                    </p>

                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">üíä Recommended Antiplatelet Strategies (Post-ACS)</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary"><strong>Strategy 1: Abbreviated DAPT</strong></h6>
                                    <ul class="mb-3">
                                        <li><strong>HBR patients only:</strong>
                                            <ul>
                                                <li>1 month DAPT (dual antiplatelet therapy)</li>
                                                <li>Then switch to P2Y‚ÇÅ‚ÇÇ inhibitor or aspirin monotherapy</li>
                                            </ul>
                                        </li>
                                        <li><strong>HBR and non-HBR patients:</strong>
                                            <ul>
                                                <li>3-6 months DAPT</li>
                                                <li>Then switch to P2Y‚ÇÅ‚ÇÇ inhibitor or aspirin monotherapy</li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-success"><strong>Strategy 2: DAPT De-escalation</strong></h6>
                                    <ul class="mb-3">
                                        <li><strong>Initial therapy:</strong>
                                            <ul>
                                                <li>Aspirin + Prasugrel, OR</li>
                                                <li>Aspirin + Ticagrelor</li>
                                            </ul>
                                        </li>
                                        <li><strong>At 3 months:</strong>
                                            <ul>
                                                <li>De-escalate: Change from potent P2Y‚ÇÅ‚ÇÇ inhibitor to clopidogrel</li>
                                                <li>Continue: Aspirin + Clopidogrel</li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div class="alert alert-info mb-3">
                                <strong><i class="bi bi-info-circle"></i> Clinical Guideline:</strong>
                                <p class="mb-2">
                                    These recommendations are based on ESC (European Society of Cardiology) guidelines
                                    for
                                    managing antiplatelet therapy in patients with high bleeding risk after acute
                                    coronary syndrome (ACS).
                                </p>
                            </div>

                            <div class="text-center mt-3">
                                <img src="{{ url_for('static', filename='images/HBR_guideline.jpg') }}"
                                    alt="HBR Antiplatelet Strategy Guideline" class="img-fluid rounded shadow"
                                    id="hbr-guideline-image" style="max-width: 100%; height: auto; cursor: pointer;">
                                <p class="text-muted mt-2">
                                    <small>Click image to view full size | Source: ESC Guidelines</small>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-danger mb-0">
                        <strong><i class="bi bi-shield-exclamation"></i> Important Note:</strong>
                        <p class="mb-0">
                            These are general recommendations based on clinical guidelines. <strong>Always consult with
                                the treating physician</strong>
                            before making any changes to antiplatelet therapy. Individual patient factors, concomitant
                            medications,
                            and clinical context must be considered.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Research Evidence Section -->
        <div class="row mt-5">
            <div class="col-12">
                <hr class="my-4">
                <h4 class="text-center mb-4">üìö Research Evidence and Citations</h4>
            </div>
        </div>

        <!-- Images Section -->
        <div class="row mt-4">
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Trade-off Scatter Plot</h5>
                    </div>
                    <div class="card-body text-center">
                        <img src="{{ url_for('static', filename='images/jama_tradeoff_scatter.png') }}"
                            alt="JAMA Trade-off Scatter Plot" class="img-fluid rounded shadow"
                            style="max-height: 400px; object-fit: contain; cursor: pointer;"
                            onclick="window.open(this.src, '_blank')">
                    </div>
                    <div class="card-footer text-muted">
                        <small><strong>Figure 3:</strong> Trade-off model showing equal (1:1) and mortality-weighted
                            (1:1.9) lines with patient distribution</small>
                    </div>
                </div>
            </div>

            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">Mortality Comparison</h5>
                    </div>
                    <div class="card-body text-center">
                        <img src="{{ url_for('static', filename='images/jama_mortality_curve.png') }}"
                            alt="JAMA Mortality Curves" class="img-fluid rounded shadow"
                            style="max-height: 400px; object-fit: contain; cursor: pointer;"
                            onclick="window.open(this.src, '_blank')">
                    </div>
                    <div class="card-footer text-muted">
                        <small><strong>Figure 2:</strong> Mortality after MI/ST (~29%) vs BARC 3-5 bleeding (~26%).
                            Excess mortality ratio: 1.9√ó</small>
                    </div>
                </div>
            </div>

            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Model Calibration</h5>
                    </div>
                    <div class="card-body text-center">
                        <img src="{{ url_for('static', filename='images/jama_calibration.png') }}"
                            alt="JAMA Model Calibration" class="img-fluid rounded shadow"
                            style="max-height: 400px; object-fit: contain; cursor: pointer;"
                            onclick="window.open(this.src, '_blank')">
                    </div>
                    <div class="card-footer text-muted">
                        <small><strong>Figure S1:</strong> Observed vs predicted risk by quintiles. Model shows good
                            calibration (C-statistic: 0.68-0.69)</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Citations Section -->
        <div class="row mt-4 mb-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üìñ Scientific References</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-3">
                            <strong>Citation Format:</strong> Research Information Systems (RIS)
                        </p>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-file-earmark-text"
                                style="font-size: 2rem; color: #198754; margin-right: 1rem;"></i>
                            <div>
                                <a href="{{ url_for('static', filename='images/citations-20251018T005817.ris') }}"
                                    class="btn btn-success btn-lg" download="ARC-HBR-Citations.ris">
                                    <i class="bi bi-download"></i> Download Citations (RIS)
                                </a>
                                <p class="text-muted mt-2 mb-0">
                                    <small>Compatible with: EndNote, Mendeley, Zotero, RefWorks, and other reference
                                        management software</small>
                                </p>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3 mb-0">
                            <strong>üí° How to use:</strong>
                            <ol class="mb-0 mt-2">
                                <li>Download the RIS file</li>
                                <li>Open your reference manager (EndNote, Mendeley, Zotero, etc.)</li>
                                <li>Import the RIS file to add all citations automatically</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Information -->
        <div class="row mt-3 mb-5">
            <div class="col-12">
                <div class="alert alert-secondary">
                    <h6><strong>About this Analysis</strong></h6>
                    <p class="mb-2">
                        This trade-off analysis is based on the ARC-HBR (Academic Research Consortium for High Bleeding
                        Risk)
                        consensus document and PRECISE-HBR bleeding risk model, validated in multiple clinical trials
                        involving
                        patients undergoing percutaneous coronary intervention (PCI).
                    </p>
                    <p class="mb-0">
                        <strong>Key References:</strong>
                    <ul class="mt-2 mb-0">
                        <li><strong style="color: #dc3545;">PRIMARY SOURCE:</strong> Costa F, Valgimigli M, et al.
                            Assessing the Risks of Bleeding vs Thrombotic Events in Patients at High Bleeding Risk
                            After Coronary Stent Implantation: The ARC-High Bleeding Risk Trade-off Model.
                            <em>JAMA Cardiology.</em> 2021;6(4):410-419.
                            <a href="https://jamanetwork.com/journals/jamacardiology/fullarticle/2774812"
                                target="_blank" class="text-primary">
                                doi:10.1001/jamacardio.2020.6602
                            </a>
                        </li>
                        <li>Urban P, et al. Defining high bleeding risk in patients undergoing percutaneous coronary
                            intervention. <em>Circulation.</em> 2019;140:240-261.</li>
                        <li>Costa F, et al. Derivation and validation of the predicting bleeding complications in
                            patients undergoing stent implantation and subsequent dual antiplatelet therapy
                            (PRECISE-DAPT) score. <em>Lancet.</em> 2017;389:1025-1034.</li>
                    </ul>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tradeoffChart;
        let modelData;

        // Chart.js Plugin for background colors
        // Based on JAMA Cardiology paper: mortality ratio is 1.9x higher after MI/ST vs bleeding
        // Equal trade-off line: y = x (1:1)
        // Mortality-weighted trade-off line: y = 0.53x (approximately 1/1.9, where 1.9 is the excess mortality ratio)
        const MORTALITY_RATIO = 1.9; // From paper: MI/ST mortality vs bleeding mortality ratio

        const backgroundPlugin = {
            id: 'customCanvasBackgroundColor',
            beforeDraw: (chart) => {
                const { ctx, chartArea, scales } = chart;
                if (!chartArea) return;
                const { left, right, top, bottom } = chartArea;
                const { x, y } = scales;

                // Define the lines based on JAMA paper
                // Upper line: Equal trade-off (y = x, or thrombotic = bleeding)
                const equalTradeoff = (val) => y.getPixelForValue(x.getValueForPixel(val));
                // Lower line: Mortality-weighted (y = x/1.9, accounting for higher MI/ST mortality)
                const mortalityWeighted = (val) => y.getPixelForValue(x.getValueForPixel(val) / MORTALITY_RATIO);

                ctx.save();

                // Teal/Cyan area (above equal trade-off line): Thrombotic risk dominates
                ctx.beginPath();
                ctx.moveTo(left, top);
                ctx.lineTo(right, top);
                ctx.lineTo(right, equalTradeoff(right));
                ctx.lineTo(left, equalTradeoff(left));
                ctx.closePath();
                ctx.fillStyle = 'rgba(135, 206, 220, 0.5)'; // Teal/cyan like paper
                ctx.fill();

                // Gray area (between lines): Risks are approximately equivalent when mortality is considered
                ctx.beginPath();
                ctx.moveTo(left, equalTradeoff(left));
                ctx.lineTo(right, equalTradeoff(right));
                ctx.lineTo(right, mortalityWeighted(right));
                ctx.lineTo(left, mortalityWeighted(left));
                ctx.closePath();
                ctx.fillStyle = 'rgba(200, 200, 200, 0.4)'; // Gray area
                ctx.fill();

                // Orange/Peach area (below mortality-weighted line): Bleeding risk dominates
                ctx.beginPath();
                ctx.moveTo(left, mortalityWeighted(left));
                ctx.lineTo(right, mortalityWeighted(right));
                ctx.lineTo(right, bottom);
                ctx.lineTo(left, bottom);
                ctx.closePath();
                ctx.fillStyle = 'rgba(255, 200, 150, 0.5)'; // Orange/peach like paper
                ctx.fill();

                // Draw the trade-off lines
                ctx.setLineDash([5, 5]);

                // Equal trade-off line (darker)
                ctx.beginPath();
                ctx.moveTo(left, equalTradeoff(left));
                ctx.lineTo(right, equalTradeoff(right));
                ctx.strokeStyle = 'rgba(0, 100, 100, 0.8)';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Mortality-weighted line (orange)
                ctx.beginPath();
                ctx.moveTo(left, mortalityWeighted(left));
                ctx.lineTo(right, mortalityWeighted(right));
                ctx.strokeStyle = 'rgba(255, 140, 0, 0.9)';
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.restore();
            }
        };

        Chart.register(backgroundPlugin);

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Show loading overlay
                document.getElementById('loading-overlay').style.display = 'flex';
                document.getElementById('main-content').classList.add('content-hidden');

                const patientId = "{{ patient_id }}";
                if (!patientId || patientId === "N/A") {
                    throw new Error("Patient ID is not available.");
                }


                const response = await fetch('/api/calculate_tradeoff', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ patientId: patientId }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server responded with status ${response.status}`);
                }

                modelData = await response.json();

                if (modelData.error) {
                    alert('Error loading tradeoff model: ' + modelData.error);
                    return;
                }

                populateFactorLists();

                // Use initial scores from the GET request to display the chart immediately
                console.log('Model data received:', modelData);
                if (modelData.initial_scores) {
                    console.log('Initial scores found:', modelData.initial_scores);
                    updateChart(modelData.initial_scores);
                } else {
                    console.error('No initial scores in model data');
                }

                // Hide loading overlay after a short delay to ensure smooth transition
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    document.getElementById('main-content').classList.remove('content-hidden');
                    document.getElementById('content-row').style.visibility = 'visible';
                }, 300);

                // Event delegation for factor checkboxes
                const allFactorsList = document.getElementById('all-factors');
                if (allFactorsList) {
                    allFactorsList.addEventListener('change', (e) => {
                        if (e.target && e.target.matches('.form-check-input')) {
                            recalculateScores();
                        }
                    });
                }

                // Event listener for guideline image
                const guidelineImg = document.getElementById('hbr-guideline-image');
                if (guidelineImg) {
                    guidelineImg.addEventListener('click', function () {
                        window.open(this.src, '_blank');
                    });
                }

            } catch (error) {
                console.error('Error loading tradeoff analysis:', error);
                alert('Error loading tradeoff analysis. Please try again.');
                document.getElementById('loading-overlay').style.display = 'none';
            }
        });

        function populateFactorLists() {
            const allFactorsList = document.getElementById('all-factors');
            if (!allFactorsList) return;

            // 1. üõ°Ô∏è ‰ΩøÁî® Optional Chaining (?.) ËàáÁ©∫Èô£ÂàóÈò≤Ë≠∑ (|| [])
            // ÈÄôÁ¢∫‰øù‰∫ÜÂ∞±ÁÆó modelData.model Ê≤íÊäìÂà∞ÔºåËÆäÊï∏‰πüÊúÉÊòØ [] ËÄå‰∏çÊòØ undefined
            const bleedingPredictors = modelData?.model?.bleedingEvents?.predictors || [];
            const thromboticPredictors = modelData?.model?.thromboticEvents?.predictors || [];

            // 2. Â¢ûÂä†Èò≤Á¶¶ÊÄßÊ™¢Êü•ÔºöÂ¶ÇÊûúÈÄ£Âü∫Êú¨ÁöÑÊï∏ÊìöÈÉΩÊ≤íÊúâÔºåÈ°ØÁ§∫ÊèêÁ§∫Ë®äÊÅØ
            if (bleedingPredictors.length === 0 && thromboticPredictors.length === 0) {
                console.warn("Êî∂Âà∞ÁöÑÊ®°ÂûãË≥áÊñôÁµêÊßã‰∏çÂÆåÊï¥:", modelData);
                allFactorsList.innerHTML = '<li class="list-group-item text-muted">Êö´ÁÑ°Ê®°ÂûãÂõ†Â≠êË≥áÊñô</li>';
                return;
            }

            const factorMap = new Map();

            // 3. ÂÆâÂÖ®Âü∑Ë°å forEach
            bleedingPredictors.forEach(p => {
                if (!p.factor) return;
                factorMap.set(p.factor, {
                    factor: p.factor,
                    description: p.description || p.factor,
                    bleeding: { hr: p.hazardRatio, ci: p.confidenceInterval },
                    thrombotic: null
                });
            });

            thromboticPredictors.forEach(p => {
                if (!p.factor) return;
                if (!factorMap.has(p.factor)) {
                    factorMap.set(p.factor, {
                        factor: p.factor,
                        description: p.description || p.factor,
                        bleeding: null,
                        thrombotic: { hr: p.hazardRatio, ci: p.confidenceInterval }
                    });
                } else {
                    factorMap.get(p.factor).thrombotic = { hr: p.hazardRatio, ci: p.confidenceInterval };
                }
            });

            // 4. Ê∏ÖÁ©∫Ê∏ÖÂñÆ‰∏¶Ê∏≤Êüì
            allFactorsList.innerHTML = '';
            const sortedFactors = Array.from(factorMap.values()).sort((a, b) => {
                const aBoth = (a.bleeding && a.thrombotic) ? 1 : 0;
                const bBoth = (b.bleeding && b.thrombotic) ? 1 : 0;
                return bBoth - aBoth || a.description.localeCompare(b.description);
            });

            sortedFactors.forEach(factorData => {
                allFactorsList.appendChild(createFactorCheckbox(factorData));
            });
        }

        function createFactorCheckbox(factorData) {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            
            // Ê™¢Êü•Ë©≤Âõ†Â≠êÊòØÂê¶Âú®ÂæåÁ´ØÂÅµÊ∏¨Âà∞ÁöÑÊ∏ÖÂñÆ‰∏≠
            const isChecked = modelData?.detected_factors?.[factorData.factor] === true;

            li.innerHTML = `
                <div class="form-check">
                    <input class="form-check-input factor-checkbox" type="checkbox" 
                        value="${factorData.factor}" id="chk-${factorData.factor}"
                        ${isChecked ? 'checked' : ''}>
                    <label class="form-check-label" for="chk-${factorData.factor}">
                        ${factorData.description}
                    </label>
                </div>
                <div>
                    ${factorData.bleeding ? '<span class="badge bg-danger me-1">B</span>' : ''}
                    ${factorData.thrombotic ? '<span class="badge bg-primary">T</span>' : ''}
                </div>
            `;
            return li;
        }


        async function recalculateScores() {
            const activeFactors = {};
            document.querySelectorAll('.form-check-input').forEach(input => {
                if (input.checked) activeFactors[input.value] = true;
            });


            const response = await fetch('/api/calculate_tradeoff', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ active_factors: activeFactors })
            });
            const scores = await response.json();
            updateChart(scores);
        }

        function updateChart(scores) {
            console.log('updateChart called with scores:', scores);
            console.log('Bleeding score:', scores.bleeding_score);
            console.log('Thrombotic score:', scores.thrombotic_score);

            // Check if scores are valid numbers
            if (!scores || typeof scores.bleeding_score !== 'number' || typeof scores.thrombotic_score !== 'number') {
                console.error('Invalid scores received:', scores);
                return;
            }

            // Check for High Bleeding Risk (HBR) - threshold at 4% per year
            // Show recommendations if bleeding risk >= 4% (ARC-HBR criteria)
            const isHBR = scores.bleeding_score >= 4.0;
            const recommendationsSection = document.getElementById('recommendations-section');
            if (isHBR) {
                recommendationsSection.style.display = 'block';
            } else {
                recommendationsSection.style.display = 'none';
            }

            // Handle zero values for logarithmic scale (log(0) is undefined)
            const bleeding_score = Math.max(scores.bleeding_score, 0.1);
            const thrombotic_score = Math.max(scores.thrombotic_score, 0.1);

            console.log('Adjusted scores - Bleeding:', bleeding_score, 'Thrombotic:', thrombotic_score);
            console.log('High Bleeding Risk (HBR):', isHBR);

            const chartData = {
                datasets: [{
                    label: 'Patient Risk Profile',
                    data: [{
                        x: bleeding_score,
                        y: thrombotic_score
                    }],
                    backgroundColor: 'rgba(255, 0, 0, 0.7)',
                    pointRadius: 8,
                    pointHoverRadius: 10,
                    pointStyle: 'circle'
                }]
            };

            console.log('Chart data:', chartData);

            if (tradeoffChart) {
                console.log('Updating existing chart');
                tradeoffChart.data = chartData;
                tradeoffChart.update();
            } else {
                const ctx = document.getElementById('tradeoffChart').getContext('2d');
                tradeoffChart = new Chart(ctx, {
                    type: 'scatter',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'logarithmic',
                                title: { display: true, text: 'Estimated 1-Year Bleeding Risk (BARC 3-5, %)' },
                                min: 0.1, max: 50,
                                ticks: {
                                    callback: function (value, index, values) { return Number(value.toString()); }
                                }
                            },
                            y: {
                                type: 'logarithmic',
                                title: { display: true, text: 'Estimated 1-Year Ischemic Risk (MI/ST, %)' },
                                min: 0.1, max: 50,
                                ticks: {
                                    callback: function (value, index, values) { return Number(value.toString()); }
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        }

        // --- Helper functions (populateFactorLists, createFactorCheckbox) are assumed to be here ---

    </script>
</body>

</html>